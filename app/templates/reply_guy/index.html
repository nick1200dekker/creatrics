{% extends "base.html" %}
{% set check_auth = true %}

{% block title %}Reply Guy - AI Twitter Engagement Tool | Creatrics{% endblock %}

{% block seo_meta %}
<meta name="description" content="Automate your Twitter engagement with AI-powered reply suggestions. Find relevant conversations and generate contextual replies to boost your social media presence.">
<meta name="keywords" content="AI Twitter replies, social media automation, Twitter engagement, automated responses">
{% endblock %}

{% block additional_styles %}
<style>
/* Reset the default content-panel padding */
.content-panel {
    padding: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
}

/* Main wrapper - consistent with other pages */
.reply-guy-wrapper {
    background: var(--bg-secondary);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-secondary);
    overflow: hidden;
    width: 100%;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

html.dark .reply-guy-wrapper {
    border-color: transparent;
}

/* Header - consistent with other pages */
.reply-guy-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-primary);
    background: var(--bg-secondary);
    transition: background-color 0.3s ease, border-color 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.reply-guy-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0;
}

.reply-guy-title i {
    color: #3B82F6;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

/* View Toggle Buttons */
.view-toggle {
    display: flex;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 4px;
    overflow: hidden;
}

html.dark .view-toggle {
    background: #3f3f46;
    border-color: #52525b;
}

.view-btn {
    padding: 0.6rem 1rem;
    border: none;
    background: transparent;
    color: #6b7280;
    font-weight: 600;
    font-size: 0.875rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.view-btn.active {
    background: #3B82F6;
    color: white;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

.view-btn:hover:not(.active) {
    color: #1f2937;
    background: #ffffff;
}

html.dark .view-btn:hover:not(.active) {
    color: #fafafa;
    background: #52525b;
}

.view-btn i {
    font-size: 0.875rem;
}

/* Secondary Button */
.secondary-btn {
    padding: 0.6rem 1rem;
    background: #f3f4f6;
    color: #1f2937;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

html.dark .secondary-btn {
    background: #3f3f46;
    color: #fafafa;
    border: 1px solid #52525b;
}

.secondary-btn:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
    color: #1f2937;
    text-decoration: none;
}

html.dark .secondary-btn:hover {
    background: #52525b;
    color: #fafafa;
}

/* Content Area */
.reply-guy-content {
    padding: 2rem;
}

/* Progress Card */
.progress-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}

html.dark .progress-card {
    background: #27272a;
    border: 1px solid #3f3f46;
}

.progress-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.progress-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
}

html.dark .progress-title {
    color: #fafafa;
}

.progress-title i {
    color: #3B82F6;
    font-size: 1.25rem;
}

.progress-stats {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
}

html.dark .progress-stats {
    color: #9ca3af;
}

.progress-content {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1.5rem;
    align-items: center;
}

@media (max-width: 768px) {
    .progress-content {
        grid-template-columns: 1fr;
        gap: 1rem;
        text-align: center;
    }
}

.progress-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.progress-text {
    color: #6b7280;
    font-size: 0.875rem;
    line-height: 1.4;
}

html.dark .progress-text {
    color: #9ca3af;
}

.progress-bar {
    background: #f3f4f6;
    border-radius: 8px;
    height: 12px;
    overflow: hidden;
    position: relative;
    margin-top: 0.5rem;
    width: 100%;
}

html.dark .progress-bar {
    background: #3f3f46;
}

.progress-fill {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    height: 100%;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px;
    position: relative;
    width: 0%;
    max-width: 100%;
}

.progress-numbers {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    min-width: 120px;
}

html.dark .progress-numbers {
    background: #3f3f46;
    border: 1px solid #52525b;
}

.progress-percentage {
    font-size: 1.5rem;
    font-weight: 700;
    color: #3B82F6;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.progress-label {
    font-size: 0.7rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}

html.dark .progress-label {
    color: #9ca3af;
}

/* Main Panel */
.main-panel {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    min-height: 600px;
    transition: all 0.3s ease;
}

html.dark .main-panel {
    background: #27272a;
    border: 1px solid #3f3f46;
}

.panel-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

html.dark .panel-header {
    background: #3f3f46;
    border-bottom: 1px solid #52525b;
}

.panel-title-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.panel-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

html.dark .panel-title {
    color: #fafafa;
}

.panel-title i {
    color: #3B82F6;
}

.panel-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
}

/* Info Icon */
.info-icon {
    width: 20px;
    height: 20px;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    cursor: help;
    transition: all 0.2s ease;
    position: relative;
}

html.dark .info-icon {
    background: #52525b;
    border: 1px solid #71717a;
    color: #9ca3af;
}

.info-icon:hover {
    background: #e5e7eb;
    color: #3B82F6;
}

html.dark .info-icon:hover {
    background: #71717a;
    color: #3B82F6;
}

/* Tooltip */
.tooltip {
    position: absolute;
    bottom: -32px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-secondary);
    color: var(--text-primary);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    border: 1px solid var(--border-primary);
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: 10;
    pointer-events: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

html.dark .tooltip {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.info-icon:hover .tooltip {
    opacity: 1;
    visibility: visible;
}

/* Dropdown */
.dropdown {
    position: relative;
    display: inline-block;
    min-width: 200px;
}

.dropdown-trigger {
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.6rem 1rem;
    color: #1f2937;
    font-size: 0.875rem;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

html.dark .dropdown-trigger {
    background: #3f3f46;
    color: #fafafa;
    border: 1px solid #52525b;
}

.dropdown-trigger:hover {
    background: #e5e7eb;
    border-color: var(--border-secondary);
}

html.dark .dropdown-trigger:hover {
    background: #52525b;
}

.dropdown-trigger.active {
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.dropdown-arrow {
    color: #6b7280;
    transition: transform 0.2s ease;
    font-size: 0.75rem;
}

html.dark .dropdown-arrow {
    color: #9ca3af;
}

.dropdown-trigger.active .dropdown-arrow {
    transform: rotate(180deg);
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 4px;
    display: none;
}

html.dark .dropdown-menu {
    background: #27272a;
    border: 1px solid #3f3f46;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.dropdown-menu.active {
    display: block;
}

.dropdown-group {
    padding: 8px 0;
}

.dropdown-group:not(:last-child) {
    border-bottom: 1px solid #e5e7eb;
}

html.dark .dropdown-group:not(:last-child) {
    border-bottom: 1px solid #3f3f46;
}

.dropdown-group-label {
    padding: 8px 16px 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #3B82F6;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.dropdown-option {
    padding: 10px 16px;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
}

html.dark .dropdown-option {
    color: #9ca3af;
}

.dropdown-option:hover {
    background: #f9fafb;
    color: #1f2937;
}

html.dark .dropdown-option:hover {
    background: #3f3f46;
    color: #fafafa;
}

.dropdown-option.selected {
    background: rgba(59, 130, 246, 0.1);
    color: #3B82F6;
}

.dropdown-option.create-new {
    color: #3B82F6;
    font-weight: 600;
    border-top: 1px solid #e5e7eb;
    margin-top: 8px;
}

html.dark .dropdown-option.create-new {
    border-top: 1px solid #3f3f46;
}

/* Primary Button */
.primary-btn {
    padding: 0.6rem 1.25rem;
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

.primary-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
}

.primary-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.primary-btn.processing {
    background: var(--bg-tertiary) !important;
    color: var(--text-secondary) !important;
    pointer-events: none !important;
    border: 1px solid var(--border-primary) !important;
    box-shadow: none !important;
}

/* Content Area */
.panel-content {
    padding: 1.5rem;
    min-height: 400px;
}

/* Tweet Opportunities */
.tweet-opportunity {
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

html.dark .tweet-opportunity {
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.tweet-opportunity:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
}

html.dark .tweet-opportunity:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.tweet-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 300px;
}

@media (max-width: 1024px) {
    .tweet-grid {
        grid-template-columns: 1fr;
    }
}

.tweet-content-section {
    padding: 1.25rem;
    border-right: 1px solid var(--border-primary);
}

@media (max-width: 1024px) {
    .tweet-content-section {
        border-right: none;
        border-bottom: 1px solid var(--border-primary);
    }
}

.tweet-author-info {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.tweet-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    margin-right: 0.75rem;
    flex-shrink: 0;
    overflow: hidden;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.tweet-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.tweet-avatar .fallback-avatar {
    display: none;
    width: 100%;
    height: 100%;
    background: var(--bg-tertiary);
    border-radius: 50%;
    justify-content: center;
    align-items: center;
    color: var(--text-tertiary);
    font-size: 1.2rem;
}

.tweet-avatar img.error {
    display: none;
}

.tweet-avatar img.error + .fallback-avatar {
    display: flex;
}

.tweet-author-details {
    flex: 1;
    min-width: 0;
}

.tweet-author-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 1rem;
    line-height: 1.2;
    margin-bottom: 2px;
}

.tweet-author-username {
    color: #1DA1F2;
    font-size: 0.875rem;
    font-weight: 500;
}

.tweet-text {
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    white-space: pre-line;
}

.tweet-link {
    color: #3B82F6;
    text-decoration: none;
    font-weight: 500;
}

.tweet-link:hover {
    text-decoration: underline;
}

.mention {
    color: #1DA1F2;
    font-weight: 500;
}

.tweet-engagement {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

.engagement-stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Reply Panel */
.reply-panel {
    padding: 1.25rem;
    background: #f9fafb;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

html.dark .reply-panel {
    background: #3f3f46;
}

.reply-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .reply-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }
}

.style-selector {
    flex: 1;
    max-width: 150px;
}

@media (max-width: 768px) {
    .style-selector {
        max-width: none;
    }
}

.brand-voice-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: #6b7280;
    user-select: none;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    white-space: nowrap;
    padding: 0.25rem;
    border-radius: 6px;
}

html.dark .brand-voice-toggle {
    color: #9ca3af;
}

.brand-voice-toggle.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.brand-voice-checkbox:checked + span {
    color: #3B82F6;
    font-weight: 600;
}

html.dark .brand-voice-checkbox:checked + span {
    color: #60A5FA;
}

.brand-voice-toggle:hover:not(.disabled) {
    background: rgba(59, 130, 246, 0.05);
    color: #3B82F6;
}

.brand-voice-checkbox {
    position: relative;
    width: 36px;
    height: 20px;
    appearance: none;
    background: #e5e7eb;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #d1d5db;
}

html.dark .brand-voice-checkbox {
    background: #52525b;
    border: 1px solid #71717a;
}

.brand-voice-checkbox:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.brand-voice-checkbox:checked {
    background: #3B82F6;
    border-color: #3B82F6;
}

.brand-voice-checkbox:disabled:checked {
    background: #9ca3af;
    border-color: #9ca3af;
}

.brand-voice-checkbox::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.brand-voice-checkbox:checked::before {
    transform: translateX(16px);
    background: white;
}

.brand-voice-checkbox:disabled::before {
    background: rgba(255, 255, 255, 0.8);
}

.reply-textarea {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    color: #1f2937;
    padding: 1rem;
    border-radius: 8px;
    transition: all 0.2s ease;
    resize: none;
    min-height: 100px;
    font-size: 0.875rem;
    width: 100%;
    font-family: inherit;
    line-height: 1.4;
}

html.dark .reply-textarea {
    background: #27272a;
    border: 1px solid #52525b;
    color: #fafafa;
}

.reply-textarea:focus {
    background: #ffffff;
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

html.dark .reply-textarea:focus {
    background: #18181b;
    border-color: #3B82F6;
}

.reply-textarea::placeholder {
    color: #9ca3af;
}

.reply-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.5rem;
}

.character-count {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
}

html.dark .character-count {
    color: #9ca3af;
}

.character-count.over-limit {
    color: #ef4444;
}

.reply-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    font-size: 0.875rem;
}

html.dark .action-btn {
    background: #52525b;
    border: 1px solid #71717a;
    color: #9ca3af;
}

.action-btn:hover {
    background: #e5e7eb;
    color: #1f2937;
    transform: scale(1.05);
}

html.dark .action-btn:hover {
    background: #71717a;
    color: #fafafa;
}

.action-btn.generate:hover {
    background: rgba(59, 130, 246, 0.1);
    color: #3B82F6;
    border-color: #3B82F6;
}

.action-btn.post:hover {
    background: rgba(16, 185, 129, 0.1);
    color: #10B981;
    border-color: #10B981;
}

/* Loading Spinner */
.loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--border-primary);
    border-top-color: #3B82F6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Empty State */
.empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 2rem;
    text-align: center;
}

.empty-icon {
    font-size: 4rem;
    color: var(--text-tertiary);
    opacity: 0.3;
    margin-bottom: 1.5rem;
}

.empty-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.empty-text {
    color: var(--text-tertiary);
    font-size: 0.875rem;
    max-width: 300px;
}

/* Lists Panel */
.lists-panel {
    display: none;
}

.lists-panel.active {
    display: block;
}

.lists-panel .panel-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

/* Form Section */
.form-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
}

html.dark .form-section {
    background: var(--bg-secondary);
}

.form-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-title i {
    color: #3B82F6;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
}

.form-input, .form-select {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    color: var(--text-primary);
    padding: 0.6rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    height: 40px;
    transition: all 0.2s ease;
    width: 100%;
    font-family: inherit;
}

html.dark .form-input, html.dark .form-select {
    background: var(--bg-tertiary);
}

.form-input:focus, .form-select:focus {
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
    background: var(--bg-secondary);
}

html.dark .form-input:focus, html.dark .form-select:focus {
    background: var(--bg-primary);
}

.form-input::placeholder {
    color: var(--text-tertiary);
}

/* Lists Display */
.lists-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.list-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.25rem;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

html.dark .list-item {
    background: var(--bg-secondary);
}

.list-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
}

html.dark .list-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.list-info {
    flex: 1;
}

.list-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.list-meta {
    display: flex;
    gap: 1rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.list-actions {
    display: flex;
    gap: 0.5rem;
}

.list-action-btn {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.list-action-btn:hover {
    transform: scale(1.05);
}

.list-action-btn.edit:hover {
    background: rgba(245, 158, 11, 0.1);
    color: #F59E0B;
    border-color: #F59E0B;
}

.list-action-btn.delete:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #EF4444;
    border-color: #EF4444;
}

.list-action-btn.refresh:hover {
    background: rgba(59, 130, 246, 0.1);
    color: #3B82F6;
    border-color: #3B82F6;
}

/* Toast Notifications */
.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    padding: 1rem 1.5rem;
    background: var(--bg-secondary);
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 1000;
    max-width: 320px;
    border-left: 4px solid #10B981;
}

html.dark .toast {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast.error {
    border-left-color: #EF4444;
}

.toast.warning {
    border-left-color: #F59E0B;
}

.toast i {
    font-size: 1.25rem;
    color: #10B981;
}

.toast.error i {
    color: #EF4444;
}

.toast.warning i {
    color: #F59E0B;
}

.toast-text {
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.875rem;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: var(--bg-secondary);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-primary);
    overflow: hidden;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.modal.show .modal-content {
    transform: scale(1);
}

html.dark .modal-content {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    transition: color 0.2s ease;
}

.modal-close:hover {
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-primary);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .reply-guy-content {
        padding: 1rem;
    }

    .reply-guy-header {
        padding: 1rem 1.5rem;
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }

    .header-actions {
        justify-content: space-between;
    }

    .panel-header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }

    .panel-controls {
        justify-content: center;
        width: 100%;
    }

    .panel-content {
        padding: 1rem;
    }

    .tweet-grid {
        grid-template-columns: 1fr;
    }

    .tweet-content-section {
        border-right: none;
        border-bottom: 1px solid var(--border-primary);
    }

    .form-section {
        padding: 1rem;
    }
}

/* Utility Classes */
.hidden {
    display: none !important;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="content-panel">
    <div class="reply-guy-wrapper">
        <!-- Header -->
        <div class="reply-guy-header">
            <h1 class="reply-guy-title">
                <i class="ph ph-chat-centered-text"></i>
                Reply Guy
            </h1>
            <div class="header-actions">
                <div class="view-toggle">
                    <button id="replies-view-btn" class="view-btn active">
                        <i class="ph ph-chat-dots"></i>
                        Replies
                    </button>
                    <button id="lists-view-btn" class="view-btn">
                        <i class="ph ph-list-plus"></i>
                        Lists
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="reply-guy-content">
            <!-- Daily Progress Card -->
            <div class="progress-card">
                <div class="progress-header">
                    <div class="progress-title">
                        <i class="ph ph-chart-line-up"></i>
                        Daily Progress
                    </div>
                    <div class="progress-stats">
                        Today's Goal: {{ reply_stats.target }} replies
                    </div>
                </div>
                <div class="progress-content">
                    <div class="progress-details">
                        <div class="progress-text">
                            You've posted <strong>{{ reply_stats.total_replies }}</strong> out of <strong>{{ reply_stats.target }}</strong> replies today. 
                            {% if reply_stats.progress_percentage >= 100 %}
                                Congratulations! You've reached your daily goal!
                            {% elif reply_stats.progress_percentage >= 75 %}
                                You're almost there! Keep it up!
                            {% elif reply_stats.progress_percentage >= 50 %}
                                Great progress! You're halfway to your goal.
                            {% else %}
                                Let's get started on your reply goals for today.
                            {% endif %}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ reply_stats.progress_percentage|int }}%"></div>
                        </div>
                    </div>
                    <div class="progress-numbers">
                        <div class="progress-percentage">{{ reply_stats.progress_percentage|int }}%</div>
                        <div class="progress-label">Complete</div>
                    </div>
                </div>
            </div>

            <!-- Replies Panel -->
            <div id="replies-panel" class="replies-panel">
                <div class="main-panel">
                    {% if current_analysis and current_analysis.tweet_opportunities %}
                    <div class="panel-header">
                        <div class="panel-title-section">
                            <h3 class="panel-title">
                                <i class="ph ph-chat-dots"></i>
                                Reply Opportunities - {{ current_analysis.list_name }}
                            </h3>
                            <div class="info-icon">
                                <i class="ph ph-info"></i>
                                <div class="tooltip">
                                    Default lists update automatically.<br>Custom lists require manual update.
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-controls">
                            <div id="update-button-container" style="display: none;">
                                <button id="update-btn" class="primary-btn" disabled>
                                    <i class="ph ph-arrows-clockwise"></i>
                                    Update
                                </button>
                            </div>
                            
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="list-dropdown-trigger">
                                    <span id="selected-list-text">Choose a list...</span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="list-dropdown-menu">
                                    {% if custom_lists %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Custom Lists</div>
                                        {% for list in custom_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="custom">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Default Lists</div>
                                        {% for list in default_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="default">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="dropdown-option create-new" id="create-new-list">
                                        <i class="ph ph-plus" style="margin-right: 0.5rem;"></i>
                                        <span>Create Custom List</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-content">
                        {% for tweet in current_analysis.tweet_opportunities %}
                        <div class="tweet-opportunity" data-tweet-id="{{ tweet.tweet_id }}">
                            <div class="tweet-grid">
                                <!-- Tweet Content -->
                                <div class="tweet-content-section">
                                    <div class="tweet-author-info">
                                        <div class="tweet-avatar">
                                            {% if tweet.profile_image_url %}
                                            <img src="{{ tweet.profile_image_url }}" alt="{{ tweet.author }}" 
                                                 onload="this.classList.remove('error')" 
                                                 onerror="this.classList.add('error')">
                                            <div class="fallback-avatar">
                                                <i class="ph ph-user"></i>
                                            </div>
                                            {% else %}
                                            <div class="fallback-avatar" style="display: flex;">
                                                <i class="ph ph-user"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="tweet-author-details">
                                            <div class="tweet-author-name">{{ tweet.name or tweet.author }}</div>
                                            <div class="tweet-author-username">@{{ tweet.author }}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="tweet-text" data-raw-text="{{ tweet.text }}">
                                        {{ tweet.text | safe }}
                                    </div>
                                    
                                    {% if tweet.media %}
                                    <div class="tweet-media">
                                        {% if tweet.media.photo %}
                                        <div class="tweet-photos">
                                            {% for photo in tweet.media.photo %}
                                            <div class="tweet-photo">
                                                <img src="{{ photo.media_url_https }}" alt="Tweet image" class="tweet-image" loading="lazy" 
                                                     onerror="this.style.display='none'">
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        
                                        {% if tweet.media.video %}
                                        <div class="tweet-videos">
                                            {% for video in tweet.media.video %}
                                            <div class="tweet-video">
                                                {% if video.variants %}
                                                    {% set mp4_variant = video.variants | selectattr('content_type', 'equalto', 'video/mp4') | list | last %}
                                                    {% if mp4_variant %}
                                                    <video controls class="tweet-video-player" poster="{{ video.media_url_https }}">
                                                        <source src="{{ mp4_variant.url }}" type="video/mp4">
                                                        Your browser does not support the video tag.
                                                    </video>
                                                    {% else %}
                                                    <img src="{{ video.media_url_https }}" alt="Video thumbnail" class="tweet-video-thumb" loading="lazy"
                                                         onerror="this.style.display='none'">
                                                    {% endif %}
                                                {% else %}
                                                <img src="{{ video.media_url_https }}" alt="Video thumbnail" class="tweet-video-thumb" loading="lazy"
                                                     onerror="this.style.display='none'">
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="tweet-engagement">
                                        <div class="engagement-stat">
                                            <i class="ph ph-heart" style="color: #ef4444;"></i>
                                            {{ tweet.engagement.likes }}
                                        </div>
                                        <div class="engagement-stat">
                                            <i class="ph ph-arrows-counter-clockwise" style="color: #22c55e;"></i>
                                            {{ tweet.engagement.retweets }}
                                        </div>
                                        <div class="engagement-stat">
                                            <i class="ph ph-eye" style="color: #3b82f6;"></i>
                                            {{ tweet.engagement.views }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Reply Panel -->
                                <div class="reply-panel">
                                    <div class="reply-controls">
                                        <div class="style-selector">
                                            <div class="dropdown">
                                                <div class="dropdown-trigger reply-style-trigger">
                                                    <span class="selected-style-text">Supportive</span>
                                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                                </div>
                                                <div class="dropdown-menu reply-style-menu">
                                                    {% for style in reply_styles %}
                                                    <div class="dropdown-option reply-style-option {% if loop.index == 1 %}selected{% endif %}" data-value="{{ style.id }}">
                                                        {{ style.name }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <label for="brand-voice-tweet-{{ tweet.tweet_id }}" class="brand-voice-toggle">
                                            <input type="checkbox" id="brand-voice-tweet-{{ tweet.tweet_id }}" class="brand-voice-checkbox">
                                            Brand Voice
                                        </label>
                                    </div>
                                    
                                    <textarea id="reply-textarea-tweet-{{ tweet.tweet_id }}" class="reply-textarea" 
                                              placeholder="Click generate to create a response..."></textarea>
                                    
                                    <div class="reply-footer">
                                        <div class="character-count">0/280</div>
                                        <div class="reply-actions">
                                            <button class="action-btn generate generate-reply-btn">
                                                <i class="ph ph-sparkle"></i>
                                            </button>
                                            <button class="action-btn post post-reply-btn">
                                                <i class="ph ph-paper-plane-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="panel-header">
                        <div class="panel-title-section">
                            <h3 class="panel-title">
                                <i class="ph ph-chat-dots"></i>
                                Reply Opportunities
                            </h3>
                            <div class="info-icon">
                                <i class="ph ph-info"></i>
                                <div class="tooltip">
                                    Default lists update automatically.<br>Custom lists require manual update.
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-controls">
                            <div id="update-button-container-empty" style="display: none;">
                                <button id="update-btn-empty" class="primary-btn" disabled>
                                    <i class="ph ph-arrows-clockwise"></i>
                                    Update
                                </button>
                            </div>
                            
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="list-dropdown-trigger-empty">
                                    <span id="selected-list-text-empty">Choose a list...</span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="list-dropdown-menu-empty">
                                    {% if custom_lists %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Custom Lists</div>
                                        {% for list in custom_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="custom">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Default Lists</div>
                                        {% for list in default_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="default">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="dropdown-option create-new" id="create-new-list-empty">
                                        <i class="ph ph-plus" style="margin-right: 0.5rem;"></i>
                                        <span>Create Custom List</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="empty-state">
                        <i class="ph ph-chat-dots empty-icon"></i>
                        <div class="empty-title">No Reply Opportunities</div>
                        <div class="empty-text" id="empty-message">Select a list to find reply opportunities.</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Lists Management Panel -->
            <div id="lists-panel" class="lists-panel">
                <div class="panel-content">
                    <!-- Create New List -->
                    <div class="form-section">
                        <h3 class="form-title">
                            <i class="ph ph-plus-circle"></i>
                            Create New List
                        </h3>
                        
                        <div class="form-row">
                            <select id="new-list-type" class="form-select">
                                <option value="x_list">X List</option>
                                <option value="manual">Manual List</option>
                            </select>
                            <input type="text" id="new-list-name" class="form-input" placeholder="Enter list name...">
                            <input type="text" id="x-list-id" class="form-input" placeholder="Enter X List ID...">
                            <button id="create-list-btn" class="primary-btn">
                                <i class="ph ph-plus"></i>
                                Create
                            </button>
                        </div>
                    </div>
                    
                    <!-- Your Custom Lists -->
                    <div class="form-section">
                        <h3 class="form-title">
                            <i class="ph ph-list-bullets"></i>
                            Your Custom Lists
                        </h3>
                        
                        <div class="lists-grid" id="custom-lists-container">
                            {% if custom_lists %}
                                {% for list in custom_lists %}
                                <div class="list-item" data-list-id="{{ list.id }}">
                                    <div class="list-info">
                                        <div class="list-name">{{ list.name }}</div>
                                        <div class="list-meta">
                                            <span>{{ list.account_count }} accounts</span>
                                            <span>{{ list.type|title }}</span>
                                            {% if list.type == 'x_list' and list.x_list_id %}
                                            <span>ID: {{ list.x_list_id }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="list-actions">
                                        <button class="list-action-btn edit edit-list-btn" data-list-id="{{ list.id }}">
                                            <i class="ph ph-pencil"></i>
                                        </button>
                                        {% if list.type == 'x_list' %}
                                        <button class="list-action-btn refresh refresh-list-btn" data-list-id="{{ list.id }}">
                                            <i class="ph ph-arrows-clockwise"></i>
                                        </button>
                                        {% endif %}
                                        <button class="list-action-btn delete delete-list-btn" data-list-id="{{ list.id }}">
                                            <i class="ph ph-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="empty-state">
                                <i class="ph ph-list-plus empty-icon"></i>
                                <div class="empty-title">No Custom Lists Yet</div>
                                <div class="empty-text">Create your first custom list to start tracking specific accounts and discovering targeted reply opportunities.</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="modal">
    <div class="modal-content">
        <div class="modal-body" style="text-align: center; padding: 2rem;">
            <div class="loading-spinner" style="margin: 0 auto 1rem; width: 32px; height: 32px; border-width: 3px;"></div>
            <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;" id="loading-text">Processing...</h3>
            <p style="color: var(--text-secondary); font-size: 0.875rem;" id="loading-description">Please wait while we process your request.</p>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div id="edit-list-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ph ph-pencil"></i>
                Edit Custom List
            </h3>
            <button class="modal-close" id="close-edit-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">List Name</label>
                <input type="text" id="edit-list-name" class="form-input">
            </div>
            
            <div id="accounts-section" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Accounts</label>
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <input type="text" id="new-account-input" class="form-input" placeholder="Add account (without @)" style="flex: 1;">
                    <button id="add-account-btn" class="primary-btn">
                        <i class="ph ph-plus"></i>
                        Add
                    </button>
                </div>
                <div id="edit-account-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <!-- Account tags will be populated here -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-edit-btn" class="secondary-btn">Cancel</button>
            <button id="save-edit-btn" class="primary-btn">Save Changes</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" style="color: #EF4444;">
                <i class="ph ph-warning"></i>
                Delete List
            </h3>
            <button class="modal-close" id="close-delete-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-primary); margin-bottom: 1rem;">Are you sure you want to delete this list? This action cannot be undone.</p>
            <p style="color: var(--text-secondary); font-size: 0.875rem;" id="delete-list-name"></p>
        </div>
        <div class="modal-footer">
            <button id="cancel-delete-btn" class="secondary-btn">Cancel</button>
            <button id="confirm-delete-btn" class="primary-btn" style="background: #EF4444;">Delete</button>
        </div>
    </div>
</div>

<script>
// Reply Guy Application
(function() {
    'use strict';
    
    // State management
    const state = {
        currentView: 'replies',
        selectedList: null,
        selectedListType: null,
        currentEditingListId: null,
        currentDeletingListId: null,
        hasBrandVoiceData: false,
        ongoingUpdates: {},
        isInitialized: false
    };

    // Initialize application
    function init() {
        if (state.isInitialized) return;
        
        console.log('Initializing Reply Guy...');
        
        // Load initial data
        loadInitialData();
        
        // Initialize components
        initializeView();
        checkBrandVoice();
        setupEventListeners();
        setupDropdowns();
        setupModals();
        
        state.isInitialized = true;
        console.log('Reply Guy initialized');
    }

    // Load initial data from server
    function loadInitialData() {
        const initialDataElement = document.getElementById('initial-data');
        if (initialDataElement) {
            try {
                const initialData = JSON.parse(initialDataElement.textContent);
                state.ongoingUpdates = initialData.ongoing_updates || {};
            } catch (error) {
                console.error('Error parsing initial data:', error);
                state.ongoingUpdates = {};
            }
        }
    }

    // Initialize view state
    function initializeView() {
        {% if current_selection and current_selection.list_id %}
        state.selectedList = "{{ current_selection.list_id }}";
        state.selectedListType = "{{ current_selection.list_type }}";
        const selectedOption = document.querySelector(`[data-value="${state.selectedList}"]`);
        if (selectedOption) {
            const selectedListText = document.getElementById('selected-list-text');
            if (selectedListText) {
                selectedListText.textContent = selectedOption.querySelector('span').textContent;
            }
            selectedOption.classList.add('selected');
        }
        {% endif %}
        
        updateButtonVisibility();
    }

    // Check brand voice availability
    function checkBrandVoice() {
        fetch('/reply-guy/check-brand-voice')
            .then(response => response.json())
            .then(data => {
                const hasData = data.success && data.has_brand_voice_data;
                setBrandVoiceState(hasData);
            })
            .catch(error => {
                console.error('Brand voice check failed:', error);
                setBrandVoiceState(false);
            });
    }

    function setBrandVoiceState(hasData) {
        state.hasBrandVoiceData = hasData;
        
        document.querySelectorAll('.brand-voice-checkbox').forEach(checkbox => {
            checkbox.disabled = !hasData;
            // Don't auto-check - let users control this
            if (!hasData) {
                checkbox.checked = false;
            }
        });
        
        document.querySelectorAll('.brand-voice-toggle').forEach(toggle => {
            if (hasData) {
                toggle.classList.remove('disabled');
                toggle.title = '';
            } else {
                toggle.classList.add('disabled');
                toggle.title = 'Connect your Twitter account to enable brand voice';
            }
        });
        
        // Handle global brand voice toggle specifically
        const globalToggle = document.querySelector('.brand-voice-toggle.global-brand-voice');
        const globalCheckbox = document.getElementById('global-brand-voice');
        
        if (globalToggle && globalCheckbox) {
            if (hasData) {
                globalToggle.classList.remove('disabled');
                globalToggle.title = 'Use your brand voice for all replies';
                // Add click handler for visual feedback
                globalCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        globalToggle.classList.add('active');
                    } else {
                        globalToggle.classList.remove('active');
                    }
                });
            } else {
                globalToggle.classList.add('disabled');
                globalToggle.title = 'Connect your Twitter account to enable brand voice';
                globalCheckbox.checked = false;
                globalToggle.classList.remove('active');
            }
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // View toggle buttons
        const repliesViewBtn = document.getElementById('replies-view-btn');
        const listsViewBtn = document.getElementById('lists-view-btn');
        
        if (repliesViewBtn) {
            repliesViewBtn.onclick = () => switchView('replies');
        }
        
        if (listsViewBtn) {
            listsViewBtn.onclick = () => switchView('lists');
        }
        
        // Update button
        const updateBtn = document.getElementById('update-btn');
        if (updateBtn) {
            updateBtn.onclick = handleUpdate;
        }
        
        // Create list button
        const createListBtn = document.getElementById('create-list-btn');
        if (createListBtn) {
            createListBtn.onclick = handleCreateList;
        }
        
        // List type dropdown
        const newListType = document.getElementById('new-list-type');
        if (newListType) {
            newListType.onchange = handleListTypeChange;
            handleListTypeChange(); // Initialize visibility
        }
        
        // Delegated event listeners for dynamic content
        document.addEventListener('click', handleDelegatedClicks);
        document.addEventListener('input', handleDelegatedInputs);
    }

    function handleDelegatedClicks(e) {
        // Generate reply button
        if (e.target.closest('.generate-reply-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.generate-reply-btn');
            if (btn.disabled) return;
            
            btn.disabled = true;
            const tweetElement = btn.closest('.tweet-opportunity');
            generateReply(tweetElement).finally(() => {
                btn.disabled = false;
            });
            return;
        }
        
        // Post reply button
        if (e.target.closest('.post-reply-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.post-reply-btn');
            if (btn.disabled) return;
            
            btn.disabled = true;
            const tweetElement = btn.closest('.tweet-opportunity');
            postReply(tweetElement);
            setTimeout(() => {
                btn.disabled = false;
            }, 1000);
            return;
        }
        
        // List management buttons
        if (e.target.closest('.edit-list-btn')) {
            const listId = e.target.closest('.edit-list-btn').getAttribute('data-list-id');
            openEditModal(listId);
        } else if (e.target.closest('.delete-list-btn')) {
            const listId = e.target.closest('.delete-list-btn').getAttribute('data-list-id');
            openDeleteModal(listId);
        } else if (e.target.closest('.refresh-list-btn')) {
            const listId = e.target.closest('.refresh-list-btn').getAttribute('data-list-id');
            refreshXList(listId);
        } else if (e.target.closest('.create-new')) {
            e.preventDefault();
            closeDropdowns();
            switchView('lists');
        }
    }

    function handleDelegatedInputs(e) {
        if (e.target.classList.contains('reply-textarea')) {
            updateCharacterCount(e.target);
        }
        
        // Handle brand voice checkbox changes
        if (e.target.classList.contains('brand-voice-checkbox')) {
            const toggle = e.target.closest('.brand-voice-toggle');
            if (toggle && !toggle.classList.contains('disabled')) {
                // Allow the checkbox to toggle normally
                console.log('Brand voice toggled:', e.target.checked);
            }
        }
    }

    function switchView(view) {
        state.currentView = view;
        
        const repliesViewBtn = document.getElementById('replies-view-btn');
        const listsViewBtn = document.getElementById('lists-view-btn');
        const repliesPanel = document.getElementById('replies-panel');
        const listsPanel = document.getElementById('lists-panel');
        
        if (view === 'replies') {
            if (repliesViewBtn) repliesViewBtn.classList.add('active');
            if (listsViewBtn) listsViewBtn.classList.remove('active');
            if (repliesPanel) repliesPanel.classList.remove('hidden');
            if (listsPanel) listsPanel.classList.remove('active');
        } else {
            if (listsViewBtn) listsViewBtn.classList.add('active');
            if (repliesViewBtn) repliesViewBtn.classList.remove('active');
            if (repliesPanel) repliesPanel.classList.add('hidden');
            if (listsPanel) listsPanel.classList.add('active');
        }
    }

    function handleListTypeChange() {
        const newListType = document.getElementById('new-list-type');
        const xListIdInput = document.getElementById('x-list-id');
        
        if (newListType && xListIdInput) {
            if (newListType.value === 'x_list') {
                xListIdInput.style.display = 'block';
                xListIdInput.required = true;
            } else {
                xListIdInput.style.display = 'none';
                xListIdInput.required = false;
            }
        }
    }

    // Setup dropdowns
    function setupDropdowns() {
        setupMainDropdown();
        setupReplyStyleDropdowns();
    }

    function setupMainDropdown() {
        const dropdownTriggers = ['list-dropdown-trigger', 'list-dropdown-trigger-empty'];
        
        dropdownTriggers.forEach(triggerId => {
            const dropdownTrigger = document.getElementById(triggerId);
            if (!dropdownTrigger) return;
            
            const menuId = triggerId === 'list-dropdown-trigger' ? 'list-dropdown-menu' : 'list-dropdown-menu-empty';
            const dropdownMenu = document.getElementById(menuId);
            
            dropdownTrigger.onclick = (e) => {
                e.stopPropagation();
                toggleMainDropdown(triggerId, menuId);
            };
        });
        
        // Option selection
        document.querySelectorAll('.dropdown-option:not(.create-new)').forEach(option => {
            option.onclick = () => selectListOption(option);
        });
        
        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                closeDropdowns();
            }
        });
    }

    function toggleMainDropdown(triggerId, menuId) {
        const dropdownTrigger = document.getElementById(triggerId);
        const dropdownMenu = document.getElementById(menuId);
        
        // Close other dropdown
        const otherTriggerId = triggerId === 'list-dropdown-trigger' ? 'list-dropdown-trigger-empty' : 'list-dropdown-trigger';
        const otherMenuId = otherTriggerId === 'list-dropdown-trigger' ? 'list-dropdown-menu' : 'list-dropdown-menu-empty';
        const otherTrigger = document.getElementById(otherTriggerId);
        const otherMenu = document.getElementById(otherMenuId);
        
        if (otherTrigger) otherTrigger.classList.remove('active');
        if (otherMenu) otherMenu.classList.remove('active');
        
        const isOpen = dropdownTrigger.classList.contains('active');
        
        if (!isOpen) {
            dropdownTrigger.classList.add('active');
            if (dropdownMenu) dropdownMenu.classList.add('active');
        } else {
            closeDropdowns();
        }
    }

    function closeDropdowns() {
        const triggers = ['list-dropdown-trigger', 'list-dropdown-trigger-empty'];
        const menus = ['list-dropdown-menu', 'list-dropdown-menu-empty'];
        
        triggers.forEach(triggerId => {
            const trigger = document.getElementById(triggerId);
            if (trigger) trigger.classList.remove('active');
        });
        
        menus.forEach(menuId => {
            const menu = document.getElementById(menuId);
            if (menu) menu.classList.remove('active');
        });
        
        // Close reply style dropdowns too
        document.querySelectorAll('.reply-style-trigger').forEach(trigger => {
            trigger.classList.remove('active');
        });
        document.querySelectorAll('.reply-style-menu').forEach(menu => {
            menu.classList.remove('active');
        });
    }

    function selectListOption(option) {
        document.querySelectorAll('.dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        option.classList.add('selected');
        state.selectedList = option.getAttribute('data-value');
        state.selectedListType = option.getAttribute('data-type');
        
        // Update both dropdown texts
        const selectedListText = document.getElementById('selected-list-text');
        const selectedListTextEmpty = document.getElementById('selected-list-text-empty');
        const optionText = option.querySelector('span').textContent;
        
        if (selectedListText) selectedListText.textContent = optionText;
        if (selectedListTextEmpty) selectedListTextEmpty.textContent = optionText;
        
        closeDropdowns();
        updateButtonVisibility();
        selectList();
    }

    function setupReplyStyleDropdowns() {
        document.querySelectorAll('.reply-style-trigger').forEach(trigger => {
            trigger.onclick = (e) => {
                e.stopPropagation();
                const dropdown = trigger.closest('.dropdown');
                toggleReplyStyleDropdown(dropdown);
            };
        });
        
        document.querySelectorAll('.reply-style-option').forEach(option => {
            option.onclick = () => {
                const dropdown = option.closest('.dropdown');
                selectReplyStyleOption(dropdown, option);
            };
        });
    }

    function toggleReplyStyleDropdown(dropdown) {
        const trigger = dropdown.querySelector('.reply-style-trigger');
        const menu = dropdown.querySelector('.reply-style-menu');
        
        // Close other reply style dropdowns
        document.querySelectorAll('.dropdown').forEach(otherDropdown => {
            if (otherDropdown !== dropdown) {
                const otherTrigger = otherDropdown.querySelector('.reply-style-trigger');
                const otherMenu = otherDropdown.querySelector('.reply-style-menu');
                if (otherTrigger) otherTrigger.classList.remove('active');
                if (otherMenu) otherMenu.classList.remove('active');
            }
        });
        
        const isOpen = trigger.classList.contains('active');
        
        if (!isOpen) {
            trigger.classList.add('active');
            if (menu) menu.classList.add('active');
        } else {
            trigger.classList.remove('active');
            if (menu) menu.classList.remove('active');
        }
    }

    function selectReplyStyleOption(dropdown, option) {
        const trigger = dropdown.querySelector('.reply-style-trigger');
        const menu = dropdown.querySelector('.reply-style-menu');
        const selectedText = dropdown.querySelector('.selected-style-text');
        
        dropdown.querySelectorAll('.reply-style-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        option.classList.add('selected');
        if (selectedText) {
            selectedText.textContent = option.textContent;
        }
        
        if (trigger) trigger.classList.remove('active');
        if (menu) menu.classList.remove('active');
    }

    // API Functions
    function updateButtonVisibility() {
        const updateButtonContainer = document.getElementById('update-button-container');
        const updateBtn = document.getElementById('update-btn');
        
        if (state.selectedListType === 'custom' && state.selectedList) {
            if (updateButtonContainer) updateButtonContainer.style.display = 'block';
            
            const isUpdating = state.selectedList in state.ongoingUpdates;
            
            if (updateBtn) {
                if (isUpdating) {
                    updateBtn.disabled = true;
                    updateBtn.classList.add('processing');
                    updateBtn.innerHTML = '<div class="loading-spinner"></div>Updating...';
                } else {
                    updateBtn.disabled = false;
                    updateBtn.classList.remove('processing');
                    updateBtn.innerHTML = '<i class="ph ph-arrows-clockwise"></i>Update';
                }
            }
        } else {
            if (updateButtonContainer) updateButtonContainer.style.display = 'none';
        }
    }

    function selectList() {
        if (!state.selectedList) return;
        
        fetch('/reply-guy/select-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                list_id: state.selectedList,
                list_type: state.selectedListType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_updating) {
                    state.ongoingUpdates[state.selectedList] = data.update_info;
                } else {
                    delete state.ongoingUpdates[state.selectedList];
                }
                
                updateButtonVisibility();
                
                if (data.has_analysis && data.opportunities_count > 0) {
                    showToast(`Found ${data.opportunities_count} opportunities! Refreshing...`, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else if (state.selectedListType === 'default') {
                    showToast('Loading default list analysis...', 'info');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const emptyMessage = document.getElementById('empty-message');
                    if (emptyMessage) {
                        emptyMessage.textContent = data.is_updating ? 
                            'Update in progress for this list...' : 
                            'Click "Update" to analyze this custom list.';
                    }
                }
            } else {
                showToast('Error selecting list: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Network error selecting list', 'error');
        });
    }

    function handleUpdate() {
        if (!state.selectedList || state.selectedListType !== 'custom') {
            return;
        }
        
        if (state.selectedList in state.ongoingUpdates) {
            showToast('Update already in progress for this list', 'warning');
            return;
        }
        
        state.ongoingUpdates[state.selectedList] = { 
            status: 'running', 
            started_at: new Date().toISOString() 
        };
        updateButtonVisibility();
        
        fetch('/reply-guy/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                list_id: state.selectedList,
                list_type: state.selectedListType,
                time_range: '24h'
            })
        })
        .then(response => response.json())
        .then(data => {
            delete state.ongoingUpdates[state.selectedList];
            
            if (data.success) {
                showToast('Analysis completed! Refreshing page...', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                if (data.is_updating) {
                    state.ongoingUpdates[state.selectedList] = { status: 'running' };
                    showToast('Update already in progress for this list', 'warning');
                } else {
                    showToast('Analysis failed: ' + data.error, 'error');
                }
                updateButtonVisibility();
            }
        })
        .catch(error => {
            delete state.ongoingUpdates[state.selectedList];
            showToast('Network error during analysis', 'error');
            updateButtonVisibility();
        });
    }

    // Reply Functions
    function generateReply(tweetElement) {
        if (!tweetElement) return Promise.resolve();
        
        const tweetId = tweetElement.getAttribute('data-tweet-id');
        const tweetTextElement = tweetElement.querySelector('.tweet-text');
        
        let tweetText = tweetTextElement ? tweetTextElement.innerHTML : '';
        tweetText = tweetText.replace(/<br\s*\/?>/gi, '\n').trim();
        tweetText = tweetText.replace(/<[^>]*>/g, '');
        
        const authorElement = tweetElement.querySelector('.tweet-author-username');
        const author = authorElement ? authorElement.textContent.replace('@', '') : '';
        const useBrandVoice = getBrandVoiceState(tweetElement);
        
        const textarea = tweetElement.querySelector('.reply-textarea');
        const generateBtn = tweetElement.querySelector('.generate-reply-btn');
        
        if (generateBtn) {
            generateBtn.innerHTML = '<div class="loading-spinner"></div>';
            generateBtn.disabled = true;
        }
        if (textarea) {
            textarea.value = 'Generating reply...';
        }
        
        return fetch('/reply-guy/generate-reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tweet_text: tweetText,
                author: author,
                style: style,
                use_brand_voice: useBrandVoice
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (textarea) {
                    textarea.value = data.reply;
                    updateCharacterCount(textarea);
                }
                showToast('Reply generated successfully!', 'success');
            } else {
                if (textarea) {
                    textarea.value = data.credits_required ? 
                        'Insufficient credits to generate reply.' : 
                        'Error generating reply: ' + data.error;
                }
                showToast(data.credits_required ? 
                    'Insufficient credits. Please purchase more credits.' : 
                    'Error generating reply', 'error');
            }
        })
        .catch(error => {
            if (textarea) {
                textarea.value = 'Network error generating reply.';
            }
            showToast('Network error', 'error');
        })
        .finally(() => {
            if (generateBtn) {
                generateBtn.innerHTML = '<i class="ph ph-sparkle"></i>';
                generateBtn.disabled = false;
            }
        });
    }

    function getSelectedStyle(tweetElement) {
        const styleDropdown = tweetElement.querySelector('.dropdown');
        const selectedOption = styleDropdown ? styleDropdown.querySelector('.reply-style-option.selected') : null;
        return selectedOption ? selectedOption.getAttribute('data-value') : 'supportive';
    }

    function getBrandVoiceState(tweetElement) {
        // Check global brand voice toggle first
        const globalCheckbox = document.getElementById('global-brand-voice');
        if (globalCheckbox && !globalCheckbox.disabled) {
            return globalCheckbox.checked;
        }
        
        // Fallback to individual checkbox (legacy)
        const checkbox = tweetElement.querySelector('.brand-voice-checkbox');
        return checkbox ? checkbox.checked : false;
    }

    function postReply(tweetElement) {
        if (!tweetElement) return;
        
        const tweetId = tweetElement.getAttribute('data-tweet-id');
        const textarea = tweetElement.querySelector('.reply-textarea');
        const replyText = textarea ? textarea.value.trim() : '';
        
        if (!replyText || replyText.includes('Error') || replyText.includes('Generating')) {
            showToast('Please generate a valid reply first', 'error');
            return;
        }
        
        if (replyText.length > 280) {
            showToast('Reply exceeds 280 characters', 'error');
            return;
        }
        
        const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(replyText)}&in_reply_to=${tweetId}`;
        
        // Open window
        window.open(tweetUrl, '_blank', 'noopener,noreferrer');
        
        // Log the reply
        fetch('/reply-guy/log-reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tweet_id: tweetId,
                reply_text: replyText
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stats) {
                updateProgressBar(data.stats);
                showToast('Reply logged successfully!', 'success');
            }
        })
        .catch(error => {
            console.error('Error logging reply:', error);
        });
    }

    function updateCharacterCount(textarea) {
        if (!textarea) return;
        
        const count = textarea.value.length;
        const counter = textarea.closest('.reply-panel')?.querySelector('.character-count');
        if (counter) {
            counter.textContent = `${count}/280`;
            if (count > 280) {
                counter.classList.add('over-limit');
            } else {
                counter.classList.remove('over-limit');
            }
        }
    }

    function updateProgressBar(stats) {
        const progressFill = document.querySelector('.progress-fill');
        const progressPercentage = document.querySelector('.progress-percentage');
        const progressText = document.querySelector('.progress-text');
        
        if (progressFill && progressPercentage && progressText) {
            const newPercentage = Math.min(Math.round(stats.progress_percentage), 100);
            
            progressFill.style.width = newPercentage + '%';
            progressPercentage.textContent = newPercentage + '%';
            
            // Update progress text with motivation
            const newProgressText = `You've posted <strong>${stats.total_replies}</strong> out of <strong>${stats.target}</strong> replies today. `;
            let motivationalText = '';
            
            if (newPercentage >= 100) {
                motivationalText = 'Congratulations! You\'ve reached your daily goal!';
            } else if (newPercentage >= 75) {
                motivationalText = 'You\'re almost there! Keep it up!';
            } else if (newPercentage >= 50) {
                motivationalText = 'Great progress! You\'re halfway to your goal.';
            } else {
                motivationalText = 'Let\'s get started on your reply goals for today.';
            }
            
            progressText.innerHTML = newProgressText + motivationalText;
        }
    }

    // List Management Functions
    function handleCreateList() {
        const nameInput = document.getElementById('new-list-name');
        const typeInput = document.getElementById('new-list-type');
        const xListIdInput = document.getElementById('x-list-id');
        
        const name = nameInput ? nameInput.value.trim() : '';
        const type = typeInput ? typeInput.value : 'x_list';
        const xListId = xListIdInput ? xListIdInput.value.trim() : '';
        
        if (!name) {
            showToast('Please enter a list name', 'error');
            return;
        }
        
        if (type === 'x_list' && !xListId) {
            showToast('Please enter an X List ID', 'error');
            return;
        }
        
        showLoading('Creating your custom list...', 'Creating your custom list...');
        
        fetch('/reply-guy/create-custom-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                type: type,
                x_list_id: type === 'x_list' ? xListId : null
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast('List created successfully!', 'success');
                
                // Clear form
                if (nameInput) nameInput.value = '';
                if (xListIdInput) xListIdInput.value = '';
                
                // Reload page to show new list
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error creating list: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Network error creating list', 'error');
        });
    }

    function refreshXList(listId) {
        showLoading('Refreshing X List', 'Fetching latest accounts from X...');
        
        fetch('/reply-guy/update-custom-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                list_id: listId,
                action: 'refresh'
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast(`List refreshed! Found ${data.account_count} accounts.`, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error refreshing list: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Network error refreshing list', 'error');
        });
    }

    // Modal functions
    function setupModals() {
        // Edit modal handlers
        const closeEditModal = document.getElementById('close-edit-modal');
        if (closeEditModal) {
            closeEditModal.onclick = () => hideModal('edit-list-modal');
        }
        
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        if (cancelEditBtn) {
            cancelEditBtn.onclick = () => hideModal('edit-list-modal');
        }
        
        const saveEditBtn = document.getElementById('save-edit-btn');
        if (saveEditBtn) {
            saveEditBtn.onclick = saveEditChanges;
        }
        
        const addAccountBtn = document.getElementById('add-account-btn');
        if (addAccountBtn) {
            addAccountBtn.onclick = addAccountToList;
        }
        
        // Delete modal handlers
        const closeDeleteModal = document.getElementById('close-delete-modal');
        if (closeDeleteModal) {
            closeDeleteModal.onclick = () => hideModal('delete-modal');
        }
        
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        if (cancelDeleteBtn) {
            cancelDeleteBtn.onclick = () => hideModal('delete-modal');
        }
        
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.onclick = confirmDelete;
        }
        
        // Close on outside click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                hideModal(e.target.id);
            }
        });
    }

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
        }
    }

    function openEditModal(listId) {
        state.currentEditingListId = listId;
        
        fetch('/reply-guy/get-custom-list-details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ list_id: listId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const list = data.list;
                const editListName = document.getElementById('edit-list-name');
                if (editListName) {
                    editListName.value = list.name;
                }
                
                const accountsSection = document.getElementById('accounts-section');
                if (accountsSection) {
                    if (list.type === 'x_list') {
                        accountsSection.style.display = 'none';
                    } else {
                        accountsSection.style.display = 'block';
                        
                        const tagsContainer = document.getElementById('edit-account-tags');
                        if (tagsContainer) {
                            tagsContainer.innerHTML = '';
                            
                            list.accounts.forEach(account => {
                                const tag = createAccountTag(account);
                                tagsContainer.appendChild(tag);
                            });
                        }
                    }
                }
                
                showModal('edit-list-modal');
            } else {
                showToast('Error loading list details: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Network error loading list details', 'error');
        });
    }

    function createAccountTag(account) {
        const tag = document.createElement('div');
        tag.style.cssText = `
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            border: 1px solid rgba(59, 130, 246, 0.3);
        `;
        tag.innerHTML = `
            @${account}
            <button style="background: none; border: none; color: #EF4444; cursor: pointer; padding: 0; font-size: 0.875rem;" data-account="${account}">×</button>
        `;
        
        const removeBtn = tag.querySelector('button');
        if (removeBtn) {
            removeBtn.onclick = function() {
                const accountToRemove = this.getAttribute('data-account');
                removeAccountFromEdit(accountToRemove);
                tag.remove();
            };
        }
        
        return tag;
    }

    function removeAccountFromEdit(account) {
        fetch('/reply-guy/update-custom-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                list_id: state.currentEditingListId,
                action: 'remove_account',
                account: account
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                showToast('Error removing account: ' + data.error, 'error');
            }
        });
    }

    function addAccountToList() {
        const newAccountInput = document.getElementById('new-account-input');
        const account = newAccountInput ? newAccountInput.value.trim() : '';
        
        if (!account) {
            showToast('Please enter an account name', 'error');
            return;
        }
        
        const cleanAccount = account.startsWith('@') ? account.slice(1) : account;
        
        fetch('/reply-guy/update-custom-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                list_id: state.currentEditingListId,
                action: 'add_account',
                account: cleanAccount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tag = createAccountTag(cleanAccount);
                const editAccountTags = document.getElementById('edit-account-tags');
                if (editAccountTags) {
                    editAccountTags.appendChild(tag);
                }
                if (newAccountInput) {
                    newAccountInput.value = '';
                }
                
                showToast('Account added successfully', 'success');
            } else {
                showToast('Error adding account: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Network error adding account', 'error');
        });
    }

    function saveEditChanges() {
        const editListName = document.getElementById('edit-list-name');
        const newName = editListName ? editListName.value.trim() : '';
        
        if (!newName) {
            showToast('Please enter a list name', 'error');
            return;
        }
        
        fetch('/reply-guy/update-custom-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                list_id: state.currentEditingListId,
                action: 'update_name',
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('List updated successfully!', 'success');
                hideModal('edit-list-modal');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error updating list: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Network error updating list', 'error');
        });
    }

    function openDeleteModal(listId) {
        state.currentDeletingListId = listId;
        
        const listItem = document.querySelector(`[data-list-id="${listId}"]`);
        const listName = listItem ? listItem.querySelector('.list-name').textContent : 'Unknown List';
        
        const deleteListName = document.getElementById('delete-list-name');
        if (deleteListName) {
            deleteListName.textContent = `List: ${listName}`;
        }
        
        showModal('delete-modal');
    }

    function confirmDelete() {
        fetch('/reply-guy/delete-custom-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ list_id: state.currentDeletingListId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('List deleted successfully!', 'success');
                hideModal('delete-modal');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error deleting list: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Network error deleting list', 'error');
        });
    }

    // Utility functions
    function showLoading(title, description) {
        const loadingText = document.getElementById('loading-text');
        const loadingDescription = document.getElementById('loading-description');
        
        if (loadingText) loadingText.textContent = title;
        if (loadingDescription) loadingDescription.textContent = description;
        
        showModal('loading-modal');
    }

    function hideLoading() {
        hideModal('loading-modal');
    }

    function showToast(message, type = 'info') {
        // Remove existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'ph-info';
        if (type === 'success') icon = 'ph-check-circle';
        else if (type === 'error') icon = 'ph-x-circle';
        else if (type === 'warning') icon = 'ph-warning';
        
        toast.innerHTML = `
            <i class="ph ${icon}"></i>
            <span class="toast-text">${message}</span>
        `;

        document.body.appendChild(toast);

        // Show toast
        setTimeout(() => toast.classList.add('show'), 100);

        // Hide toast
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', init);

})();
</script>
{% endblock %}