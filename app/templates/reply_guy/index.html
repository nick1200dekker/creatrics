{% extends "base.html" %}
{% set check_auth = true %}

{% block title %}Reply Guy - AI Twitter Engagement Tool | Creatrics{% endblock %}

{% block seo_meta %}
<meta name="description" content="Automate your Twitter engagement with AI-powered reply suggestions. Find relevant conversations and generate contextual replies to boost your social media presence.">
<meta name="keywords" content="AI Twitter replies, social media automation, Twitter engagement, automated responses">
{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reply_guy.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='scripts/reply_guy.js') }}"></script>
<!-- Data element for initializing JS with server data -->
<div id="reply-guy-data"
     {% if current_selection and current_selection.list_id %}
     data-selected-list-id="{{ current_selection.list_id }}"
     data-selected-list-type="{{ current_selection.list_type }}"
     {% endif %}
     style="display: none;"></div>
<script>
// Legacy initialization for template variables
(function() {
    {% if current_selection and current_selection.list_id %}
    // Template data will be picked up by reply_guy.js
    {% endif %}
})();
</script>
{% endblock %}

{% block content %}
<div class="content-panel">
    <div class="reply-guy-wrapper">
        <!-- Header -->
        <div class="reply-guy-header">
            <h1 class="reply-guy-title">
                <i class="ph ph-chat-centered-text"></i>
                Reply Guy
            </h1>
            <div class="header-actions">
                <div class="view-toggle">
                    <button id="replies-view-btn" class="view-btn active">
                        <i class="ph ph-chat-dots"></i>
                        Replies
                    </button>
                    <button id="lists-view-btn" class="view-btn">
                        <i class="ph ph-list-plus"></i>
                        Lists
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="reply-guy-content">
            <!-- Daily Progress Card -->
            <div class="progress-card">
                <div class="progress-header">
                    <div class="progress-title">
                        <i class="ph ph-chart-line-up"></i>
                        Daily Progress
                    </div>
                    <div class="progress-stats">
                        Today's Goal: {{ reply_stats.target }} replies
                    </div>
                </div>
                <div class="progress-content">
                    <div class="progress-details">
                        <div class="progress-text">
                            You've posted <strong>{{ reply_stats.total_replies }}</strong> out of <strong>{{ reply_stats.target }}</strong> replies today. 
                            {% if reply_stats.progress_percentage >= 100 %}
                                Congratulations! You've reached your daily goal!
                            {% elif reply_stats.progress_percentage >= 75 %}
                                You're almost there! Keep it up!
                            {% elif reply_stats.progress_percentage >= 50 %}
                                Great progress! You're halfway to your goal.
                            {% else %}
                                Let's get started on your reply goals for today.
                            {% endif %}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ reply_stats.progress_percentage|int }}%"></div>
                        </div>
                    </div>
                    <div class="progress-numbers">
                        <div class="progress-percentage">{{ reply_stats.progress_percentage|int }}%</div>
                        <div class="progress-label">Complete</div>
                    </div>
                </div>
            </div>

            <!-- Replies Panel -->
            <div id="replies-panel" class="replies-panel">
                <div class="main-panel">
                    {% if current_analysis and current_analysis.tweet_opportunities %}
                    <div class="panel-header">
                        <div class="panel-title-section">
                            <h3 class="panel-title">
                                <i class="ph ph-chat-dots"></i>
                                Reply Opportunities - {{ current_analysis.list_name }}
                            </h3>
                            <div class="info-icon">
                                <i class="ph ph-info"></i>
                                <div class="tooltip">
                                    Default lists update automatically.<br>Custom lists require manual update.
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-controls">
                            <div id="update-button-container" style="display: none;">
                                <button id="update-btn" class="primary-btn" disabled>
                                    <i class="ph ph-arrows-clockwise"></i>
                                    Update
                                </button>
                            </div>
                            
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="list-dropdown-trigger">
                                    <span id="selected-list-text">Choose a list...</span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="list-dropdown-menu">
                                    {% if custom_lists %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Custom Lists</div>
                                        {% for list in custom_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="custom">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Default Lists</div>
                                        {% for list in default_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="default">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="dropdown-option create-new" id="create-new-list">
                                        <i class="ph ph-plus" style="margin-right: 0.5rem;"></i>
                                        <span>Create Custom List</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-content">
                        {% for tweet in current_analysis.tweet_opportunities %}
                        <div class="tweet-opportunity" data-tweet-id="{{ tweet.tweet_id }}">
                            <div class="tweet-grid">
                                <!-- Tweet Content -->
                                <div class="tweet-content-section">
                                    <div class="tweet-author-info">
                                        <div class="tweet-avatar">
                                            {% if tweet.profile_image_url %}
                                            <img src="{{ tweet.profile_image_url }}" alt="{{ tweet.author }}" 
                                                 onload="this.classList.remove('error')" 
                                                 onerror="this.classList.add('error')">
                                            <div class="fallback-avatar">
                                                <i class="ph ph-user"></i>
                                            </div>
                                            {% else %}
                                            <div class="fallback-avatar" style="display: flex;">
                                                <i class="ph ph-user"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="tweet-author-details">
                                            <div class="tweet-author-name">{{ tweet.name or tweet.author }}</div>
                                            <div class="tweet-author-username">@{{ tweet.author }}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="tweet-text" data-raw-text="{{ tweet.text }}">
                                        {{ tweet.text | safe }}
                                    </div>
                                    
                                    {% if tweet.media %}
                                    <div class="tweet-media">
                                        {% if tweet.media.photo %}
                                        <div class="tweet-photos">
                                            {% for photo in tweet.media.photo %}
                                            <div class="tweet-photo">
                                                <img src="{{ photo.media_url_https }}" alt="Tweet image" class="tweet-image" loading="lazy" 
                                                     onerror="this.style.display='none'">
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        
                                        {% if tweet.media.video %}
                                        <div class="tweet-videos">
                                            {% for video in tweet.media.video %}
                                            <div class="tweet-video">
                                                {% if video.variants %}
                                                    {% set mp4_variant = video.variants | selectattr('content_type', 'equalto', 'video/mp4') | list | last %}
                                                    {% if mp4_variant %}
                                                    <video controls class="tweet-video-player" poster="{{ video.media_url_https }}">
                                                        <source src="{{ mp4_variant.url }}" type="video/mp4">
                                                        Your browser does not support the video tag.
                                                    </video>
                                                    {% else %}
                                                    <img src="{{ video.media_url_https }}" alt="Video thumbnail" class="tweet-video-thumb" loading="lazy"
                                                         onerror="this.style.display='none'">
                                                    {% endif %}
                                                {% else %}
                                                <img src="{{ video.media_url_https }}" alt="Video thumbnail" class="tweet-video-thumb" loading="lazy"
                                                     onerror="this.style.display='none'">
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="tweet-engagement">
                                        <div class="engagement-stat">
                                            <i class="ph ph-heart" style="color: #ef4444;"></i>
                                            {{ tweet.engagement.likes }}
                                        </div>
                                        <div class="engagement-stat">
                                            <i class="ph ph-arrows-counter-clockwise" style="color: #22c55e;"></i>
                                            {{ tweet.engagement.retweets }}
                                        </div>
                                        <div class="engagement-stat">
                                            <i class="ph ph-eye" style="color: #3b82f6;"></i>
                                            {{ tweet.engagement.views }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Reply Panel -->
                                <div class="reply-panel">
                                    <div class="reply-panel-header">
                                        <div class="style-selector">
                                            <div class="dropdown">
                                                <div class="dropdown-trigger reply-style-trigger">
                                                    <span class="selected-style-text">Supportive</span>
                                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                                </div>
                                                <div class="dropdown-menu reply-style-menu">
                                                    {% for style in reply_styles %}
                                                    <div class="dropdown-option reply-style-option {% if loop.index == 1 %}selected{% endif %}" data-value="{{ style.id }}">
                                                        {{ style.name }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>

                                        <label for="brand-voice-tweet-{{ tweet.tweet_id }}" class="brand-voice-toggle">
                                            <input type="checkbox" id="brand-voice-tweet-{{ tweet.tweet_id }}" class="brand-voice-checkbox">
                                            <span class="toggle-slider"></span>
                                            <span class="toggle-label">Brand Voice</span>
                                        </label>
                                    </div>
                                    
                                    <textarea id="reply-textarea-tweet-{{ tweet.tweet_id }}" class="reply-textarea" 
                                              placeholder="Click generate to create a response..."></textarea>
                                    
                                    <div class="reply-footer">
                                        <div class="character-count">0/280</div>
                                        <div class="reply-actions">
                                            <button class="action-btn generate generate-reply-btn">
                                                <i class="ph ph-sparkle"></i>
                                            </button>
                                            <button class="action-btn post post-reply-btn">
                                                <i class="ph ph-paper-plane-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="panel-header">
                        <div class="panel-title-section">
                            <h3 class="panel-title">
                                <i class="ph ph-chat-dots"></i>
                                Reply Opportunities
                            </h3>
                            <div class="info-icon">
                                <i class="ph ph-info"></i>
                                <div class="tooltip">
                                    Default lists update automatically.<br>Custom lists require manual update.
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-controls">
                            <div id="update-button-container-empty" style="display: none;">
                                <button id="update-btn-empty" class="primary-btn" disabled>
                                    <i class="ph ph-arrows-clockwise"></i>
                                    Update
                                </button>
                            </div>
                            
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="list-dropdown-trigger-empty">
                                    <span id="selected-list-text-empty">Choose a list...</span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="list-dropdown-menu-empty">
                                    {% if custom_lists %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Custom Lists</div>
                                        {% for list in custom_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="custom">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="dropdown-group">
                                        <div class="dropdown-group-label">Default Lists</div>
                                        {% for list in default_lists %}
                                        <div class="dropdown-option" data-value="{{ list.id }}" data-type="default">
                                            <span>{{ list.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="dropdown-option create-new" id="create-new-list-empty">
                                        <i class="ph ph-plus" style="margin-right: 0.5rem;"></i>
                                        <span>Create Custom List</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="empty-state">
                        <i class="ph ph-chat-dots empty-icon"></i>
                        <div class="empty-title">No Reply Opportunities</div>
                        <div class="empty-text" id="empty-message">Select a list to find reply opportunities.</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Lists Management Panel -->
            <div id="lists-panel" class="lists-panel">
                <div class="panel-content">
                    <!-- Create New List -->
                    <div class="form-section">
                        <h3 class="form-title">
                            <i class="ph ph-plus-circle"></i>
                            Create New List
                        </h3>
                        
                        <div class="form-row">
                            <select id="new-list-type" class="form-select">
                                <option value="x_list">X List</option>
                                <option value="manual">Manual List</option>
                            </select>
                            <input type="text" id="new-list-name" class="form-input" placeholder="Enter list name...">
                            <input type="text" id="x-list-id" class="form-input" placeholder="Enter X List ID...">
                            <button id="create-list-btn" class="primary-btn">
                                <i class="ph ph-plus"></i>
                                Create
                            </button>
                        </div>
                    </div>
                    
                    <!-- Your Custom Lists -->
                    <div class="form-section">
                        <h3 class="form-title">
                            <i class="ph ph-list-bullets"></i>
                            Your Custom Lists
                        </h3>
                        
                        <div class="lists-grid" id="custom-lists-container">
                            {% if custom_lists %}
                                {% for list in custom_lists %}
                                <div class="list-item" data-list-id="{{ list.id }}">
                                    <div class="list-info">
                                        <div class="list-name">{{ list.name }}</div>
                                        <div class="list-meta">
                                            <span>{{ list.account_count }} accounts</span>
                                            <span>{{ list.type|title }}</span>
                                            {% if list.type == 'x_list' and list.x_list_id %}
                                            <span>ID: {{ list.x_list_id }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="list-actions">
                                        <button class="list-action-btn edit edit-list-btn" data-list-id="{{ list.id }}">
                                            <i class="ph ph-pencil"></i>
                                        </button>
                                        {% if list.type == 'x_list' %}
                                        <button class="list-action-btn refresh refresh-list-btn" data-list-id="{{ list.id }}">
                                            <i class="ph ph-arrows-clockwise"></i>
                                        </button>
                                        {% endif %}
                                        <button class="list-action-btn delete delete-list-btn" data-list-id="{{ list.id }}">
                                            <i class="ph ph-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="empty-state">
                                <i class="ph ph-list-plus empty-icon"></i>
                                <div class="empty-title">No Custom Lists Yet</div>
                                <div class="empty-text">Create your first custom list to start tracking specific accounts and discovering targeted reply opportunities.</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="modal">
    <div class="modal-content">
        <div class="modal-body" style="text-align: center; padding: 2rem;">
            <div class="loading-spinner" style="margin: 0 auto 1rem; width: 32px; height: 32px; border-width: 3px;"></div>
            <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;" id="loading-text">Processing...</h3>
            <p style="color: var(--text-secondary); font-size: 0.875rem;" id="loading-description">Please wait while we process your request.</p>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div id="edit-list-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ph ph-pencil"></i>
                Edit Custom List
            </h3>
            <button class="modal-close" id="close-edit-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">List Name</label>
                <input type="text" id="edit-list-name" class="form-input">
            </div>
            
            <div id="accounts-section" style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Accounts</label>
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <input type="text" id="new-account-input" class="form-input" placeholder="Add account (without @)" style="flex: 1;">
                    <button id="add-account-btn" class="primary-btn">
                        <i class="ph ph-plus"></i>
                        Add
                    </button>
                </div>
                <div id="edit-account-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <!-- Account tags will be populated here -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-edit-btn" class="secondary-btn">Cancel</button>
            <button id="save-edit-btn" class="primary-btn">Save Changes</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" style="color: #EF4444;">
                <i class="ph ph-warning"></i>
                Delete List
            </h3>
            <button class="modal-close" id="close-delete-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-primary); margin-bottom: 1rem;">Are you sure you want to delete this list? This action cannot be undone.</p>
            <p style="color: var(--text-secondary); font-size: 0.875rem;" id="delete-list-name"></p>
        </div>
        <div class="modal-footer">
            <button id="cancel-delete-btn" class="secondary-btn">Cancel</button>
            <button id="confirm-delete-btn" class="primary-btn" style="background: #EF4444;">Delete</button>
        </div>
    </div>
</div>


{% endblock %}
