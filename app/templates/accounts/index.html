{% extends "base.html" %}
{% set check_auth = true %}

{% block title %}Social Accounts - Creator Tools{% endblock %}

{% block head %}
{{ super() }}
<!-- Disable Turbo for this page to ensure full reload -->
<meta name="turbo-visit-control" content="reload">
<meta name="turbo-cache-control" content="no-cache">
{% endblock %}

{% block additional_styles %}
<style>
/* Reset default content-panel padding like Brain Dump */
.content-panel {
    padding: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
}

/* Main Container */
.accounts-wrapper {
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-primary);
    overflow: hidden;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    width: 100%;
    max-width: 100%;
}

/* Header Section */
.accounts-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-primary);
    background: linear-gradient(135deg,
        rgba(59, 130, 246, 0.03) 0%,
        rgba(139, 92, 246, 0.03) 100%);
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

html.dark .accounts-header {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.06) 0%, rgba(139, 92, 246, 0.06) 100%);
    border-bottom-color: rgba(63, 63, 70, 0.5);
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.page-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.page-title i {
    color: #3B82F6;
}

html.dark .page-title i {
    color: #60A5FA;
}

/* Content Section */
.accounts-content {
    padding: 2rem;
    width: 100%;
    max-width: none;
}

/* Flash Messages */
.flash-message {
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
}

.flash-message.error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #EF4444;
}

html.dark .flash-message.error {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.4);
    color: #F87171;
}

.flash-message.success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #10B981;
}

html.dark .flash-message.success {
    background: rgba(16, 185, 129, 0.2);
    border-color: rgba(16, 185, 129, 0.4);
    color: #34D399;
}

/* Beta Warning */
.beta-warning {
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-left: 4px solid #F59E0B;
    color: #92400E;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    line-height: 1.6;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

html.dark .beta-warning {
    background: linear-gradient(135deg, rgba(254, 243, 199, 0.15) 0%, rgba(253, 230, 138, 0.15) 100%);
    border-color: rgba(245, 158, 11, 0.4);
    color: #FCD34D;
}

.beta-warning i {
    font-size: 1.25rem;
    flex-shrink: 0;
    margin-top: 0.1rem;
}

.beta-warning a {
    color: #92400E;
    text-decoration: underline;
    font-weight: 600;
}

html.dark .beta-warning a {
    color: #FCD34D;
}

.beta-warning a:hover {
    color: #78350F;
}

html.dark .beta-warning a:hover {
    color: #FDE68A;
}

/* Account Cards Grid */
.accounts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
    width: 100%;
    max-width: none;
}

/* On larger screens, use full width */
@media (min-width: 1280px) {
    .accounts-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 768px) and (max-width: 1279px) {
    .accounts-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Account Card */
.account-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

html.dark .account-card {
    background: rgba(39, 39, 42, 0.6);
    border-color: rgba(63, 63, 70, 0.6);
    backdrop-filter: blur(10px);
}

.account-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    border-color: rgba(59, 130, 246, 0.3);
}

html.dark .account-card:hover {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    border-color: rgba(96, 165, 250, 0.4);
}

.account-card.disabled {
    opacity: 0.6;
    pointer-events: none;
    position: relative;
}

/* Card Header */
.card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.25rem;
}

.platform-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
    flex-shrink: 0;
}

.platform-icon.x-platform {
    background: linear-gradient(135deg, #000000 0%, #333333 100%);
}

.platform-icon.youtube-platform {
    background: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);
}

.platform-icon.tiktok-platform {
    background: linear-gradient(135deg, #000000 0%, #333333 100%);
}

.platform-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
}

/* Connection Status */
.connection-status {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 60px;
}

.status-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.status-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.status-value {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: #3B82F6;
    color: white;
}

/* Form Elements */
.form-group {
    margin-bottom: 1.75rem;
}

.form-label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    font-family: 'Inter', sans-serif;
    letter-spacing: 0.02em;
}

html.dark .form-label {
    color: #d4d4d8;
}

.form-input {
    width: 100%;
    padding: 0.875rem;
    border: 1px solid var(--border-primary);
    border-radius: 10px;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 0.9rem;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    transition: all 0.2s ease;
    line-height: 1.6;
}

html.dark .form-input {
    background: rgba(63, 63, 70, 0.5);
    border-color: rgba(82, 82, 91, 0.5);
}

.form-input:focus {
    outline: none;
    border-color: #3B82F6;
    background: var(--bg-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

html.dark .form-input:focus {
    background: rgba(39, 39, 42, 0.8);
    border-color: #60A5FA;
    box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
}

.form-input::placeholder {
    color: var(--text-tertiary);
}

.form-input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--bg-tertiary);
}

/* Buttons */
.action-button {
    width: 100%;
    padding: 0.625rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    border: none;
    text-decoration: none;
}

.action-button.primary {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.action-button.primary:hover {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

html.dark .action-button.primary {
    background: linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%);
}

html.dark .action-button.primary:hover {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
}

.action-button.secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
}

.action-button.loading {
    opacity: 0.7;
    cursor: not-allowed;
    pointer-events: none;
}

.action-button .button-spinner {
    display: none;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.action-button.loading .button-spinner {
    display: block;
}

.action-button.loading .button-icon {
    display: none;
}

.action-button.secondary:hover {
    background: var(--hover-bg);
    transform: translateY(-1px);
}


/* Info Section */
.info-section {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s ease;
}

html.dark .info-section {
    background: rgba(39, 39, 42, 0.6);
    border-color: rgba(63, 63, 70, 0.6);
    backdrop-filter: blur(10px);
}

.info-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

.info-text {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.6;
}

html.dark .info-text {
    color: #d4d4d8;
}

/* Super Powers Modal */
.super-powers-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(0px);
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.super-powers-modal.visible {
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(8px);
    opacity: 1;
    pointer-events: auto;
}

.super-powers-container {
    background: var(--bg-secondary);
    border-radius: 20px;
    padding: 0;
    width: 90%;
    max-width: 480px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-primary);
    transform: translateY(30px) scale(0.9);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.super-powers-modal.visible .super-powers-container {
    transform: translateY(0) scale(1);
    opacity: 1;
}

/* Icon Area */
.modal-icon-area {
    position: relative;
    padding: 3rem 2rem 2rem 2rem;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    align-items: center;
    justify-content: center;
}

html.dark .modal-icon-area {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
}

.icon-wrapper {
    position: relative;
    z-index: 2;
    width: 80px;
    height: 80px;
    border-radius: 20px;
    background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
}

.icon-wrapper i {
    font-size: 2.5rem;
    color: white;
}

.pulse-ring {
    position: absolute;
    width: 80px;
    height: 80px;
    border-radius: 20px;
    border: 2px solid #3B82F6;
    opacity: 0;
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.pulse-ring-delay {
    animation-delay: 1s;
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 0.8;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

/* Modal Content */
.modal-content {
    padding: 2rem;
    text-align: center;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

.modal-description {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 2rem;
}

/* Progress Section */
.progress-section {
    margin-bottom: 1.75rem;
}

.progress-bar-wrapper {
    width: 100%;
    height: 6px;
    background: var(--border-primary);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 0.75rem;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #3B82F6 0%, #8B5CF6 100%);
    border-radius: 10px;
    transition: width 0.3s ease;
    width: 0%;
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}

.progress-status {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.status-text {
    font-size: 0.875rem;
    color: var(--text-secondary);
    flex: 1;
    text-align: left;
}

.status-percent {
    font-size: 0.875rem;
    font-weight: 600;
    color: #3B82F6;
    font-variant-numeric: tabular-nums;
}

html.dark .status-percent {
    color: #60A5FA;
}

/* Modal Info */
.modal-info {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(59, 130, 246, 0.05);
    border: 1px solid rgba(59, 130, 246, 0.1);
    border-radius: 10px;
    margin-bottom: 1.5rem;
    text-align: left;
}

html.dark .modal-info {
    background: rgba(59, 130, 246, 0.08);
    border-color: rgba(59, 130, 246, 0.15);
}

.modal-info i {
    font-size: 1.25rem;
    color: #3B82F6;
    flex-shrink: 0;
    margin-top: 0.125rem;
}

html.dark .modal-info i {
    color: #60A5FA;
}

.modal-info span {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* Dismiss Button */
.dismiss-button {
    width: 100%;
    padding: 0.875rem 1.5rem;
    border-radius: 10px;
    font-size: 0.9375rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    border: 1px solid var(--border-primary);
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.dismiss-button:hover {
    background: var(--hover-bg);
    transform: translateY(-1px);
    border-color: rgba(59, 130, 246, 0.3);
}

.dismiss-button i {
    font-size: 1rem;
    transition: transform 0.2s ease;
}

.dismiss-button:hover i {
    transform: translateX(3px);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.modal-close-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(0, 0, 0, 0.1);
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.25rem;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    transition: all 0.2s ease;
    z-index: 10;
}

html.dark .modal-close-btn {
    background: rgba(255, 255, 255, 0.05);
}

.modal-close-btn:hover {
    background: rgba(0, 0, 0, 0.2);
    color: var(--text-primary);
}

html.dark .modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
    .accounts-header {
        padding: 1rem;
    }
    
    .accounts-content {
        padding: 1rem;
    }
    
    .accounts-grid {
        grid-template-columns: 1fr;
    }
    
    .page-title {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="accounts-wrapper">
    <!-- Super Powers Modal (always present, hidden by default) -->
    <div class="super-powers-modal" id="superPowersModal">
        <div class="super-powers-container">
            <button class="modal-close-btn" onclick="closeSuperPowers()" title="Close and continue in background">
                <i class="ph ph-x"></i>
            </button>

            <!-- Icon/Animation Area -->
            <div class="modal-icon-area">
                <div class="icon-wrapper">
                    <i id="modalPlatformIcon" class="ph ph-x-logo"></i>
                </div>
                <div class="pulse-ring"></div>
                <div class="pulse-ring pulse-ring-delay"></div>
            </div>

            <div class="modal-content">
                <h3 id="modalPlatformTitle" class="modal-title">Setting Up X</h3>

                <p class="modal-description">
                    We're fetching your content and analyzing your analytics. This usually takes 1-2 minutes.
                </p>

                <!-- Progress Section -->
                <div class="progress-section">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-status">
                        <span id="loadingText" class="status-text">Pulling data from your account...</span>
                        <span id="progressPercent" class="status-percent">0%</span>
                    </div>
                </div>

                <!-- Dismissible Info -->
                <div class="modal-info">
                    <i class="ph ph-info"></i>
                    <span>You can close this and continue using the app. The setup will continue in the background.</span>
                </div>

                <button class="dismiss-button" onclick="closeSuperPowers()">
                    <span>Got it, continue in background</span>
                    <i class="ph ph-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="accounts-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="ph ph-link"></i>
                Social Accounts
            </h1>
        </div>
    </div>
    
    <!-- Content -->
    <div class="accounts-content">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">
                        <i class="ph ph-{{ 'check-circle' if category == 'success' else 'warning-circle' }}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Alpha Testing Warning for YouTube -->
        {% if not youtube_connected %}
        <div class="beta-warning">
            <i class="ph ph-warning-circle"></i>
            <div>
                <strong>Alpha Testing - Limited Access</strong><br>
                YouTube connection is currently in alpha testing. To get access, please email
                <a href="mailto:support@creatrics.com">support@creatrics.com</a> with your email address.
            </div>
        </div>
        {% endif %}

        <!-- Account Cards -->
        <div class="accounts-grid">
            <!-- YouTube Account -->
            <div class="account-card">
                <div class="card-header">
                    <div class="platform-icon youtube-platform" style="background: transparent !important;">
                        <img src="{{ url_for('static', filename='img/templates/yt_icon_red_digital.png') }}" alt="YouTube" style="width: 48px; height: 48px;">
                    </div>
                    <h2 class="platform-name">YouTube Channel</h2>
                </div>
                
                {% if youtube_connected and youtube_setup_complete %}
                    <div class="connection-status">
                        <div class="status-info">
                            <span class="status-label">Connected</span>
                            <span class="status-value">{{ youtube_channel }}</span>
                        </div>
                        <span class="status-badge">Active</span>
                    </div>

                    <form method="POST" action="{{ url_for('accounts.disconnect_account') }}">
                        <input type="hidden" name="platform" value="youtube">
                        <button type="submit" class="action-button secondary">
                            <i class="ph ph-link-break"></i>
                            Disconnect Channel
                        </button>
                    </form>
                {% else %}
                    <div class="form-group">
                        <label for="youtube_channel" class="form-label">Channel</label>
                        <input type="text"
                               id="youtube_channel"
                               name="youtube_channel"
                               class="form-input"
                               placeholder="Press connect button"
                               disabled>
                    </div>

                    <a href="{{ url_for('accounts.youtube_connect_redirect') }}"
                       class="action-button primary"
                       id="connectYouTubeBtn"
                       data-turbo="false">
                        <div class="button-spinner"></div>
                        <i class="ph ph-link button-icon"></i>
                        Connect with YouTube
                    </a>
                {% endif %}
            </div>

            <!-- X Account -->
            <div class="account-card">
                <div class="card-header">
                    <div class="platform-icon x-platform">
                        <i class="ph ph-x-logo"></i>
                    </div>
                    <h2 class="platform-name">X Account</h2>
                </div>

                {% if x_connected and x_setup_complete %}
                    <div class="connection-status">
                        <div class="status-info">
                            <span class="status-label">Connected</span>
                            <span class="status-value">@{{ x_username }}</span>
                        </div>
                        <span class="status-badge">Active</span>
                    </div>

                    <form method="POST" action="{{ url_for('accounts.disconnect_account') }}">
                        <input type="hidden" name="platform" value="x">
                        <button type="submit" class="action-button secondary">
                            <i class="ph ph-link-break"></i>
                            Disconnect Account
                        </button>
                    </form>
                {% else %}
                    <form method="POST" action="{{ url_for('accounts.connect_account') }}" data-turbo="false">
                        <input type="hidden" name="platform" value="x">

                        <div class="form-group">
                            <label for="x_username" class="form-label">Username</label>
                            <input type="text"
                                   id="x_username"
                                   name="x_username"
                                   class="form-input"
                                   placeholder="username"
                                   required>
                        </div>

                        <button type="submit" class="action-button primary" id="connectXBtn">
                            <div class="button-spinner"></div>
                            <i class="ph ph-link button-icon"></i>
                            Configure Account
                        </button>
                    </form>
                {% endif %}
            </div>

            <!-- TikTok Account -->
            <div class="account-card">
                <div class="card-header">
                    <div class="platform-icon tiktok-platform">
                        <i class="ph ph-tiktok-logo"></i>
                    </div>
                    <h2 class="platform-name">TikTok Account</h2>
                </div>
                
                {% if tiktok_connected and tiktok_setup_complete %}
                    <div class="connection-status">
                        <div class="status-info">
                            <span class="status-label">Connected</span>
                            <span class="status-value">@{{ tiktok_username }}</span>
                        </div>
                        <span class="status-badge">Active</span>
                    </div>

                    <form method="POST" action="{{ url_for('accounts.disconnect_account') }}">
                        <input type="hidden" name="platform" value="tiktok">
                        <button type="submit" class="action-button secondary">
                            <i class="ph ph-link-break"></i>
                            Disconnect Account
                        </button>
                    </form>
                {% else %}
                    <form method="POST" action="{{ url_for('accounts.connect_account') }}" data-turbo="false">
                        <input type="hidden" name="platform" value="tiktok">
                        
                        <div class="form-group">
                            <label for="tiktok_username" class="form-label">Username</label>
                            <input type="text" 
                                   id="tiktok_username" 
                                   name="tiktok_username" 
                                   class="form-input" 
                                   placeholder="username" 
                                   required>
                        </div>
                        
                        <button type="submit" class="action-button primary" id="connectTikTokBtn">
                            <div class="button-spinner"></div>
                            <i class="ph ph-link button-icon"></i>
                            Configure Account
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="info-section">
            <h3 class="info-title">Why configure your accounts?</h3>
            <p class="info-text">
                Configuring your social accounts allows Creatrics to provide personalized content suggestions
                and analyze engagement metrics. For YouTube, connecting via the API gives you access to detailed
                analytics data including views, watch time, audience demographics, and more.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ensure Turbo is fully disabled for this page
    if (window.Turbo) {
        Turbo.cache.clear();
    }

    // Check on page load if any platform is still being set up
    const connectXBtn = document.getElementById('connectXBtn');
    const connectTikTokBtn = document.getElementById('connectTikTokBtn');
    const connectYouTubeBtn = document.getElementById('connectYouTubeBtn');

    // Check X setup status
    {% if x_connected and user_data.get('x_setup_complete') == False %}
        if (connectXBtn) connectXBtn.classList.add('loading');
        startBackgroundPolling('x');
    {% endif %}

    // Check TikTok setup status
    {% if tiktok_connected and user_data.get('tiktok_setup_complete') == False %}
        if (connectTikTokBtn) connectTikTokBtn.classList.add('loading');
        startBackgroundPolling('tiktok');
    {% endif %}

    // Check YouTube setup status
    {% if youtube_connected and user_data.get('youtube_setup_complete') == False %}
        if (connectYouTubeBtn) connectYouTubeBtn.classList.add('loading');
        startBackgroundPolling('youtube');
    {% endif %}

    function showModalForPlatform(platform) {
        const modal = document.getElementById('superPowersModal');
        const icon = document.getElementById('modalPlatformIcon');
        const title = document.getElementById('modalPlatformTitle');

        const configs = {
            'x': { icon: 'x-logo', title: 'Setting Up X' },
            'tiktok': { icon: 'tiktok-logo', title: 'Setting Up TikTok' },
            'youtube': { icon: 'yt-icon', title: 'Setting Up YouTube' }
        };

        const config = configs[platform];
        if (icon) {
            if (platform === 'youtube') {
                icon.innerHTML = '<img src="/static/img/templates/yt_icon_red_digital.png" alt="YouTube" style="width: 32px; height: 32px;">';
            } else {
                icon.className = `ph ph-${config.icon}`;
            }
        }
        if (title) title.textContent = config.title;

        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('visible');
            startProgressBar(platform);
        });
    }

    if (connectXBtn) {
        connectXBtn.closest('form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const formData = new FormData(form);

            connectXBtn.classList.add('loading');

            // Delay for smooth transition
            setTimeout(() => {
                // Show modal
                showModalForPlatform('x');

                // Submit via fetch - NO PAGE REDIRECT!
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                // Remove loading state from button
                connectXBtn.classList.remove('loading');
            }, 500);
        });
    }

    if (connectTikTokBtn) {
        connectTikTokBtn.closest('form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const formData = new FormData(form);

            connectTikTokBtn.classList.add('loading');

            // Delay for smooth transition
            setTimeout(() => {
                // Show modal
                showModalForPlatform('tiktok');

                // Submit via fetch - NO PAGE REDIRECT!
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                // Remove loading state from button
                connectTikTokBtn.classList.remove('loading');
            }, 500);
        });
    }
});

function startProgressBar(platformParam) {
    const progressBar = document.getElementById('progressBar');
    const loadingText = document.getElementById('loadingText');
    const progressPercent = document.getElementById('progressPercent');

    if (!progressBar || !loadingText || !progressPercent) return;

    // Use passed platform parameter
    const platform = platformParam || 'x';

    let progress = 0;
    const maxProgress = 95; // Don't go to 100% until we confirm completion
    const duration = 120 * 1000; // 2 minutes estimate
    const interval = 100; // Update every 100ms
    const increment = (interval / duration) * 100;

    const stages = [
        { percent: 0, text: 'Pulling data from your account...' },
        { percent: 25, text: 'Fetching your content...' },
        { percent: 50, text: 'Analyzing engagement data...' },
        { percent: 75, text: 'Processing metrics...' },
        { percent: 90, text: 'Finalizing setup...' }
    ];

    // Progress bar update timer
    const timer = setInterval(function() {
        if (progress < maxProgress) {
            progress += increment;
            if (progress > maxProgress) progress = maxProgress;

            // Update loading text based on progress
            for (let i = stages.length - 1; i >= 0; i--) {
                if (progress >= stages[i].percent) {
                    loadingText.textContent = stages[i].text;
                    break;
                }
            }

            progressBar.style.width = progress + '%';
            progressPercent.textContent = Math.round(progress) + '%';
        }
    }, interval);

    // Poll for completion status
    const pollInterval = setInterval(function() {
        fetch(`/accounts/connection-status?platform=${platform}`)
            .then(response => response.json())
            .then(data => {
                if (data.complete) {
                    // Setup is complete!
                    clearInterval(timer);
                    clearInterval(pollInterval);

                    // Store for cleanup
                    window.progressTimer = null;
                    window.pollTimer = null;

                    // Check if modal is still visible
                    const modal = document.getElementById('superPowersModal');
                    const isModalVisible = modal && modal.classList.contains('visible');

                    if (isModalVisible) {
                        // Modal is open - show 100% and auto-close
                        progress = 100;
                        progressBar.style.width = '100%';
                        progressPercent.textContent = '100%';
                        loadingText.textContent = 'Setup complete!';

                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    } else {
                        // Modal was closed manually - just reload immediately
                        window.location.reload();
                    }
                }
            })
            .catch(error => {
                console.error('Error checking connection status:', error);
            });
    }, 2000); // Check every 2 seconds

    // Store timer IDs so we can clear them if modal is closed
    window.progressTimer = timer;
    window.pollTimer = pollInterval;
}

function startBackgroundPolling(platform) {
    // Poll for completion without showing modal (for when user returns to page)
    const pollInterval = setInterval(function() {
        fetch(`/accounts/connection-status?platform=${platform}`)
            .then(response => response.json())
            .then(data => {
                if (data.complete) {
                    clearInterval(pollInterval);
                    // Reload page to show updated UI
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error checking connection status:', error);
            });
    }, 2000); // Check every 2 seconds
}

function closeSuperPowers() {
    const modal = document.getElementById('superPowersModal');
    if (modal) {
        // Clear progress timer (visual only)
        if (window.progressTimer) {
            clearInterval(window.progressTimer);
            window.progressTimer = null;
        }

        // Keep poll timer running in background - don't clear it!
        // Show spinner on button to indicate background processing
        const connectXBtn = document.getElementById('connectXBtn');
        const connectTikTokBtn = document.getElementById('connectTikTokBtn');
        const connectYouTubeBtn = document.getElementById('connectYouTubeBtn');
        if (connectXBtn) connectXBtn.classList.add('loading');
        if (connectTikTokBtn) connectTikTokBtn.classList.add('loading');
        if (connectYouTubeBtn) connectYouTubeBtn.classList.add('loading');

        modal.classList.remove('visible');

        // Remove modal after transition
        setTimeout(function() {
            modal.style.display = 'none';
        }, 300);
    }
}

// Disable Turbo for all links on this page to ensure clean navigation
document.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (link && !link.hasAttribute('data-turbo')) {
        link.setAttribute('data-turbo', 'false');
    }
});
</script>
{% endblock %}