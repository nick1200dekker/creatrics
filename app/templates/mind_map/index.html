{% extends "base.html" %}

{% block title %}AI Mind Map - Visual Brainstorming & Idea Mapping | Creatrics{% endblock %}

{% block seo_meta %}
<meta name="description" content="Create interactive mind maps with AI assistance. Visualize ideas, build connections, and organize thoughts with Creatrics intelligent mind mapping tool.">
<meta name="keywords" content="AI mind map, visual brainstorming, idea mapping, concept visualization, knowledge graph, interactive flowchart">
{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mind_map.css') }}">
<style>
/* Reset the default content-panel padding */
.content-panel {
    padding: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="content-panel">
    <div class="mind-map-wrapper">
        <!-- Map Tabs -->
        <div class="mind-map-tabs" id="mapTabs">
            <div class="tab-list">
                <div class="tab active" data-map-id="map1">
                    <span class="tab-name" ondblclick="editTabName(this)" title="Double-click to rename">Map 1</span>
                    <button class="tab-close" onclick="closeMap('map1')" title="Close Map">Ã—</button>
                </div>
                <button class="tab-add" onclick="createNewMap()" title="New Map">
                    <i class="ph ph-plus"></i>
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="mind-map-toolbar">
            <button class="toolbar-btn" id="selectTool" title="Select" data-tool="select">
                <i class="ph ph-cursor"></i>
            </button>
            <button class="toolbar-btn" id="addNodeBtn" title="Add Node" onclick="addNewNode()">
                <i class="ph ph-plus"></i>
            </button>
            <button class="toolbar-btn" id="connectTool" title="Connect Nodes" onclick="toggleConnectionMode()">
                <i class="ph ph-flow-arrow"></i>
            </button>
            <button class="toolbar-btn active" id="propertiesBtn" title="Properties Panel" onclick="togglePropertiesPanel()">
                <i class="ph ph-gear"></i>
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" id="saveBtn" title="Save" onclick="handleSave()">
                <i class="ph ph-floppy-disk"></i>
            </button>
        </div>

        <!-- Controls Panel -->
        <div class="mind-map-controls" id="controlsPanel" style="display: block;">
            <div class="controls-header">
                <span class="controls-title">Properties</span>
                <button class="controls-close" id="closeControls" onclick="togglePropertiesPanel()">
                    <i class="ph ph-x"></i>
                </button>
            </div>

            <div class="properties-panel show" id="nodeProperties">
                <div class="property-group">
                    <div class="property-label">Instructions</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        1. Click a node to select it<br>
                        2. Use controls below to customize<br>
                        3. Click + button to add nodes<br>
                        4. Use connect tool to link nodes
                    </div>
                </div>

                <div class="property-group">
                    <div class="property-label">Text</div>
                    <textarea class="property-input" id="nodeText" placeholder="Node text..." onchange="updateSelectedNode()"></textarea>
                </div>

                <div class="property-group">
                    <div class="property-label">Shape</div>
                    <select class="property-input" id="nodeShape" onchange="updateSelectedNode()">
                        <option value="rectangle">Rectangle</option>
                        <option value="circle">Circle</option>
                        <option value="square">Square</option>
                        <option value="diamond">Diamond</option>
                    </select>
                </div>

                <div class="property-group">
                    <div class="property-label">Color</div>
                    <div class="color-options">
                        <div class="color-option" style="background: #3B82F6;" onclick="changeNodeColor('#3B82F6')" title="Blue"></div>
                        <div class="color-option" style="background: #EF4444;" onclick="changeNodeColor('#EF4444')" title="Red"></div>
                        <div class="color-option" style="background: #10B981;" onclick="changeNodeColor('#10B981')" title="Green"></div>
                        <div class="color-option" style="background: #F59E0B;" onclick="changeNodeColor('#F59E0B')" title="Orange"></div>
                        <div class="color-option" style="background: #8B5CF6;" onclick="changeNodeColor('#8B5CF6')" title="Purple"></div>
                        <div class="color-option" style="background: #EC4899;" onclick="changeNodeColor('#EC4899')" title="Pink"></div>
                        <div class="color-option" style="background: #06B6D4;" onclick="changeNodeColor('#06B6D4')" title="Cyan"></div>
                        <div class="color-option" style="background: #84CC16;" onclick="changeNodeColor('#84CC16')" title="Lime"></div>
                    </div>
                </div>

                <div class="property-group">
                    <div class="property-label">Font Size</div>
                    <select class="property-input" id="nodeFontSize" onchange="updateSelectedNode()">
                        <option value="12px">Small</option>
                        <option value="14px" selected>Normal</option>
                        <option value="16px">Large</option>
                        <option value="18px">Extra Large</option>
                    </select>
                </div>

                <div class="property-group">
                    <div class="property-label">Actions</div>
                    <button class="property-input" onclick="copySelectedNode()" style="background: #3B82F6; color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; margin-bottom: 0.5rem;">
                        <i class="ph ph-copy"></i> Copy Node
                    </button>
                    <button class="property-input" id="deleteNodeBtn" onclick="deleteSelectedNode()" style="background: #3B82F6; color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">
                        <i class="ph ph-trash"></i> Delete Node
                    </button>
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="mind-map-canvas" id="mindMapCanvas" style="flex: 1; position: relative;">
            <svg class="canvas-svg" id="connectionsSvg">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#3B82F6" />
                    </marker>
                </defs>
            </svg>
            <div class="canvas-container" id="canvasContainer"></div>
        </div>

        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomInBtn" title="Zoom In">
                <i class="ph ph-plus"></i>
            </button>
            <div class="zoom-level" id="zoomLevel">100%</div>
            <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="ph ph-minus"></i>
            </button>
            <button class="zoom-btn" id="zoomResetBtn" title="Reset Zoom">
                <i class="ph ph-arrows-out"></i>
            </button>
        </div>


        <!-- Loading State -->
        <div class="mind-map-loading" id="loadingState" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading mind map...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='scripts/mind_map.js') }}"></script>
<script>
console.log('Inline script loaded');
console.log('Available functions:', {
    saveToFirebase: typeof saveToFirebase,
    addNewNode: typeof addNewNode,
    createNewMap: typeof createNewMap
});

// Wait for external script to fully load
setTimeout(() => {
    console.log('After timeout - Available functions:', {
        saveToFirebase: typeof saveToFirebase,
        maps: typeof maps,
        currentMapId: typeof currentMapId
    });
}, 100);
// Simple utility functions for UI interactions
function togglePropertiesPanel() {
    const panel = document.getElementById('controlsPanel');
    const btn = document.getElementById('propertiesBtn');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.classList.add('active');
    } else {
        panel.style.display = 'none';
        btn.classList.remove('active');
    }
}


function toggleConnectionMode() {
    const btn = document.getElementById('connectTool');
    
    if (connectionMode) {
        // Exit connection mode
        connectionMode = false;
        btn.classList.remove('active');
        btn.innerHTML = '<i class="ph ph-flow-arrow"></i>';
        btn.title = 'Connect Nodes';
        
        // Reset any selected node for connection
        if (firstConnectionNode) {
            firstConnectionNode.style.border = '';
            firstConnectionNode = null;
        }
    } else {
        // Enter connection mode
        connectionMode = true;
        btn.classList.add('active');
        btn.innerHTML = '<i class="ph ph-x"></i>';
        btn.title = 'Cancel Connect';
        firstConnectionNode = null;
    }
}

function updateSelectedNode() {
    console.log('updateSelectedNode called, selectedNode:', selectedNode);
    
    if (!selectedNode) {
        console.log('No selected node, trying to get from window.selectedNode');
        selectedNode = window.selectedNode;
        if (!selectedNode) {
            console.log('Still no selected node');
            return;
        }
    }
    
    const textArea = document.getElementById('nodeText');
    const shapeSelect = document.getElementById('nodeShape');
    const fontSelect = document.getElementById('nodeFontSize');
    
    if (textArea && textArea.value !== selectedNode.querySelector('.node-text').textContent) {
        selectedNode.querySelector('.node-text').textContent = textArea.value;
    }
    
    if (shapeSelect) {
        // Remove old shape classes
        selectedNode.classList.remove('shape-circle', 'shape-square', 'shape-diamond');
        
        // Add new shape class
        if (shapeSelect.value !== 'rectangle') {
            selectedNode.classList.add('shape-' + shapeSelect.value);
        }
    }
    
    if (fontSelect) {
        selectedNode.querySelector('.node-text').style.fontSize = fontSelect.value;
    }
    
    updateConnections();
}

function changeNodeColor(color) {
    let nodeToColor = selectedNode || window.selectedNode;
    
    if (!nodeToColor) {
        alert('Please select a node first');
        return;
    }
    
    console.log('Changing color to:', color);
    console.log('Selected node:', nodeToColor);
    console.log('Node style before:', nodeToColor.style.cssText);
    
    // Set the background color
    nodeToColor.style.backgroundColor = color;
    
    console.log('Node style after:', nodeToColor.style.cssText);
    console.log('Node has background-color in style?', nodeToColor.style.cssText.includes('background-color'));
    
    // Update color selection
    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
    const colorElement = document.querySelector(`[onclick*="${color}"]`);
    if (colorElement) {
        colorElement.classList.add('selected');
    }
    
    console.log('Changed node color to:', color);
}

async function handleSave() {
    console.log('Save button clicked');
    
    const saveBtn = document.getElementById('saveBtn');
    const originalHTML = saveBtn.innerHTML;
    
    // Check if saveToFirebase function exists
    if (typeof saveToFirebase === 'function') {
        console.log('Calling saveToFirebase...');
        
        // Show loading state
        saveBtn.innerHTML = '<i class="ph ph-spinner ph-spin"></i>';
        saveBtn.disabled = true;
        
        try {
            await saveToFirebase();
            
            // Show success state
            saveBtn.innerHTML = '<i class="ph ph-check"></i>';
            setTimeout(() => {
                saveBtn.innerHTML = originalHTML;
                saveBtn.disabled = false;
            }, 1000);
            
        } catch (error) {
            console.error('Save error:', error);
            
            // Show error state
            saveBtn.innerHTML = '<i class="ph ph-x"></i>';
            setTimeout(() => {
                saveBtn.innerHTML = originalHTML;
                saveBtn.disabled = false;
            }, 1000);
        }
    } else {
        console.error('saveToFirebase function not found!');
        alert('Save function not available. Please refresh the page.');
    }
}

function editTabName(spanElement) {
    const currentName = spanElement.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentName;
    input.style.background = 'transparent';
    input.style.border = '1px solid #3B82F6';
    input.style.borderRadius = '4px';
    input.style.padding = '2px 4px';
    input.style.fontSize = '0.875rem';
    input.style.width = '80px';
    
    spanElement.parentNode.replaceChild(input, spanElement);
    input.focus();
    input.select();
    
    function finishEdit() {
        const newName = input.value.trim() || currentName;
        const newSpan = document.createElement('span');
        newSpan.className = 'tab-name';
        newSpan.textContent = newName;
        newSpan.ondblclick = () => editTabName(newSpan);
        newSpan.title = 'Double-click to rename';
        
        input.parentNode.replaceChild(newSpan, input);
        
        // Update the map name in the maps object
        const tab = newSpan.closest('.tab');
        const mapId = tab.getAttribute('data-map-id');
        if (maps[mapId]) {
            maps[mapId].name = newName;
        }
        
        console.log('Renamed map', mapId, 'to', newName);
    }
    
    input.addEventListener('blur', finishEdit);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            finishEdit();
        } else if (e.key === 'Escape') {
            const newSpan = document.createElement('span');
            newSpan.className = 'tab-name';
            newSpan.textContent = currentName;
            newSpan.ondblclick = () => editTabName(newSpan);
            newSpan.title = 'Double-click to rename';
            input.parentNode.replaceChild(newSpan, input);
        }
    });
}

function closeMap(mapId) {
    if (Object.keys(maps).length <= 1) {
        alert('Cannot close the last map');
        return;
    }
    
    if (confirm('Are you sure you want to close this map?')) {
        delete maps[mapId];
        
        // Remove tab
        const tab = document.querySelector(`[data-map-id="${mapId}"]`);
        if (tab) tab.remove();
        
        // Switch to first available map if this was active
        if (currentMapId === mapId) {
            const firstMapId = Object.keys(maps)[0];
            switchToMap(firstMapId);
        }
        
        console.log('Closed map:', mapId);
    }
}

function updateConnectionArrow() {
    if (!selectedConnection) return;
    
    const arrowSelect = document.getElementById('connectionArrow');
    if (arrowSelect) {
        selectedConnection.arrowType = arrowSelect.value;
        
        if (arrowSelect.value === 'arrow') {
            selectedConnection.element.setAttribute('marker-end', 'url(#arrowhead)');
        } else {
            selectedConnection.element.removeAttribute('marker-end');
        }
        
        console.log('Updated connection arrow type to:', arrowSelect.value);
    }
}

function changeConnectionColor(color) {
    if (!selectedConnection) return;
    
    selectedConnection.color = color;
    selectedConnection.element.setAttribute('stroke', color);
    
    // Update color selection
    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
    const colorElement = document.querySelector(`[onclick*="${color}"]`);
    if (colorElement) {
        colorElement.classList.add('selected');
    }
    
    console.log('Changed connection color to:', color);
}
</script>
{% endblock %}
