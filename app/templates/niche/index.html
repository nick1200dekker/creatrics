{% extends "base.html" %}

{% block title %}Niche Radar - Creatrics{% endblock %}

{% block seo_meta %}
<meta name="description" content="Analyze trending content and track creators in your niche with AI-powered insights. Discover what's hot on your timeline and optimize your content strategy with Niche Radar.">
<meta name="keywords" content="niche analysis, creator tracking, content trends, social media analytics, X analytics, creator insights">
{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/niche_radar.css') }}">
{% endblock %}

{% block content %}
<div class="flex-1 space-y-4 w-full">
    <!-- Header -->
    <div class="tracker-premium-card">
        <div class="p-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="ph ph-radar text-teal-primary mr-3"></i>
                Niche Radar
            </h2>
            <div class="flex space-x-3">
                <div class="tracker-view-toggle">
                    <button id="analytics-view-btn" class="tracker-view-toggle-btn active">
                        <i class="ph ph-chart-line"></i>
                        Analytics
                    </button>
                    <button id="lists-view-btn" class="tracker-view-toggle-btn">
                        <i class="ph ph-list-plus"></i>
                        Lists
                    </button>
                </div>
                <a href="{{ url_for('teams.teams_dashboard') }}" class="tracker-secondary-button">
                    <i class="ph ph-house"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Analytics Panel -->
    <div id="analytics-panel" class="analytics-panel">
        {% if latest_analysis %}
        <!-- Hot on Timeline -->
        {% if hot_on_timeline %}
        <div class="hot-timeline-container">
            <div class="tracker-section-header-with-controls">
                <div class="tracker-section-title-info">
                    <h3 class="tracker-section-title">
                        <i class="ph ph-trend-up"></i>
                        What's Hot in Your Niche Right Now
                    </h3>
                </div>
                <div class="tracker-section-controls">
                    <div class="tracker-form-label-group">
                        <label for="list-select" class="tracker-form-label">List Name</label>
                        <select id="list-select" class="tracker-form-select">
                            {% if creator_lists %}
                                {% for list in creator_lists %}
                                    <option value="{{ list.name }}" {% if default_list == list.name %}selected{% endif %}>
                                        {{ list.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="">No lists available</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="tracker-form-label-group">
                        <label for="time-range-select" class="tracker-form-label">Time Range</label>
                        <select id="time-range-select" class="tracker-form-select">
                            <option value="24h">Last 24 Hours</option>
                            <option value="48h">Last 48 Hours</option>
                            <option value="72h">Last 72 Hours</option>
                            <option value="1w">Last Week</option>
                        </select>
                    </div>
                    
                    <div class="tracker-analyze-button-group">
                        <label for="analyze-button" class="tracker-form-label">Action</label>
                        <button id="analyze-button" class="tracker-premium-button" {% if not creator_lists %}disabled{% endif %}>
                            <i class="ph ph-arrows-clockwise"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="hot-timeline">
                {{ hot_on_timeline|safe }}
            </div>
        </div>
        {% else %}
        <div class="hot-timeline-container">
            <div class="tracker-section-header-with-controls">
                <div class="tracker-section-title-info">
                    <h3 class="tracker-section-title">
                        <i class="ph ph-trend-up"></i>
                        What's Hot in Your Niche Right Now
                    </h3>
                </div>
                <div class="tracker-section-controls">
                    <div class="tracker-form-label-group">
                        <label for="list-select-2" class="tracker-form-label">List Name</label>
                        <select id="list-select-2" class="tracker-form-select">
                            {% if creator_lists %}
                                {% for list in creator_lists %}
                                    <option value="{{ list.name }}" {% if default_list == list.name %}selected{% endif %}>
                                        {{ list.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="">No lists available</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="tracker-form-label-group">
                        <label for="time-range-select-2" class="tracker-form-label">Time Range</label>
                        <select id="time-range-select-2" class="tracker-form-select">
                            <option value="24h">Last 24 Hours</option>
                            <option value="48h">Last 48 Hours</option>
                            <option value="72h">Last 72 Hours</option>
                            <option value="1w">Last Week</option>
                        </select>
                    </div>
                    
                    <div class="tracker-analyze-button-group">
                        <label for="analyze-button-2" class="tracker-form-label">Action</label>
                        <button id="analyze-button-2" class="tracker-premium-button" {% if not creator_lists %}disabled{% endif %}>
                            <i class="ph ph-arrows-clockwise"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="hot-timeline">
                <p>Click "Analyze" to generate insights from your creator lists.</p>
            </div>
        </div>
        {% endif %}

        <!-- Charts -->
        {% if performance_chart_data %}
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-chat-circle-text"></i>
                    </div>
                    <h3 class="chart-title">Tweets Count</h3>
                </div>
                <div class="chart-container">
                    <div id="tweets-chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-heart"></i>
                    </div>
                    <h3 class="chart-title">Total Likes</h3>
                </div>
                <div class="chart-container">
                    <div id="likes-chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-eye"></i>
                    </div>
                    <h3 class="chart-title">Total Views</h3>
                </div>
                <div class="chart-container">
                    <div id="views-chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-percent"></i>
                    </div>
                    <h3 class="chart-title">Engagement Rate</h3>
                </div>
                <div class="chart-container">
                    <div id="engagement-chart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        {% endif %}
        {% else %}
        <!-- Empty Analytics State -->
        <div class="hot-timeline-container">
            <div class="tracker-section-header-with-controls">
                <div class="tracker-section-title-info">
                    <h3 class="tracker-section-title">
                        <i class="ph ph-trend-up"></i>
                        What's Hot in Your Niche Right Now
                    </h3>
                </div>
                <div class="tracker-section-controls">
                    <div class="tracker-form-label-group">
                        <label for="list-select-3" class="tracker-form-label">List Name</label>
                        <select id="list-select-3" class="tracker-form-select">
                            {% if creator_lists %}
                                {% for list in creator_lists %}
                                    <option value="{{ list.name }}" {% if default_list == list.name %}selected{% endif %}>
                                        {{ list.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="">No lists available</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="tracker-form-label-group">
                        <label for="time-range-select-3" class="tracker-form-label">Time Range</label>
                        <select id="time-range-select-3" class="tracker-form-select">
                            <option value="24h">Last 24 Hours</option>
                            <option value="48h">Last 48 Hours</option>
                            <option value="72h">Last 72 Hours</option>
                            <option value="1w">Last Week</option>
                        </select>
                    </div>
                    
                    <div class="tracker-analyze-button-group">
                        <label for="analyze-button-3" class="tracker-form-label">Action</label>
                        <button id="analyze-button-3" class="tracker-premium-button" {% if not creator_lists %}disabled{% endif %}>
                            <i class="ph ph-arrows-clockwise"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="tracker-empty-state">
                <div class="tracker-empty-state-icon">
                    <i class="ph ph-chart-line"></i>
                </div>
                <h3>No Analytics Data</h3>
                <p>{% if not creator_lists %}Create a list first to start analyzing creators.{% else %}Select a list and click "Analyze" to generate comprehensive insights from your tracked creators.{% endif %}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Lists Management Panel -->
    <div id="lists-panel" class="lists-panel">
        <!-- Create New List Panel -->
        <div class="tracker-premium-card">
            <div class="p-4">
                <div class="tracker-section-header-with-controls">
                    <div class="tracker-section-title-info">
                        <h3 class="tracker-section-title">
                            <i class="ph ph-plus-circle"></i>
                            Create New List
                        </h3>
                    </div>
                </div>
                
                <div class="tracker-creation-form">
                    <div class="tracker-form-inputs-row">
                        <div>
                            <label for="new-list-type-select" class="sr-only">List type</label>
                            <select id="new-list-type-select" name="new-list-type" class="tracker-form-input">
                                <option value="x_list">X List</option>
                                <option value="manual">Manual List</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-list-name-input" class="sr-only">List name</label>
                            <input type="text" id="new-list-name-input" name="new-list-name" placeholder="Enter list name..." class="tracker-form-input">
                        </div>
                        <div id="x-list-id-container" class="x-list-id-container show">
                            <label for="x-list-id-input" class="sr-only">X List ID</label>
                            <input type="text" id="x-list-id-input" name="x-list-id" placeholder="Enter X List ID..." class="tracker-form-input">
                        </div>
                        <div>
                            <button id="create-list-btn" type="button" class="tracker-create-btn">
                                <i class="ph ph-plus"></i>
                                Create List
                            </button>
                        </div>
                    </div>
                    <div id="x-list-help-container" class="x-list-help-container show">
                        <div class="x-list-help">
                            <i class="ph ph-info"></i>
                            <div class="x-list-help-content">
                                <div class="x-list-help-title">How to find your List ID</div>
                                <div class="x-list-help-text">Go to your list on X and copy the last part from the URL.<br>For example: x.com/i/lists/<strong>1234567890</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Your Custom Lists Panel -->
        <div class="tracker-premium-card">
            <div class="p-4">
                <div class="tracker-section-header-with-controls">
                    <div class="tracker-section-title-info">
                        <h3 class="tracker-section-title">
                            <i class="ph ph-list-bullets"></i>
                            Your Creator Lists
                        </h3>
                    </div>
                </div>
                
                <div id="custom-lists-container">
                    {% if creator_lists %}
                        {% for list in creator_lists %}
                        <div class="tracker-list-item" data-list-name="{{ list.name }}">
                            <div class="tracker-list-item-content">
                                <div class="tracker-list-item-header">
                                    <div class="tracker-list-info">
                                        <div class="tracker-list-name-container">
                                            <h5 class="tracker-list-name">{{ list.name }}</h5>
                                            <span class="tracker-list-type-badge {{ 'x_list' if list.is_x_list else 'manual' }}">
                                                {% if list.is_x_list %}
                                                <i class="ph ph-link"></i>
                                                X List
                                                {% else %}
                                                <i class="ph ph-pencil"></i>
                                                Manual
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="tracker-list-metadata">
                                            <div class="tracker-metadata-item">
                                                <i class="ph ph-users"></i>
                                                <span>{{ list.creators|length }} creators</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tracker-list-actions">
                                        {% if list.is_x_list %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn update-x-list-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-arrows-clockwise"></i>
                                            <div class="tracker-tooltip">Update from X</div>
                                        </div>
                                        {% else %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn edit-list-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-pencil"></i>
                                            <div class="tracker-tooltip">Edit Creators</div>
                                        </div>
                                        {% endif %}
                                        {% if default_list != list.name %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn set-default-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-star"></i>
                                            <div class="tracker-tooltip">Set as Default</div>
                                        </div>
                                        {% endif %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn delete delete-list-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-trash"></i>
                                            <div class="tracker-tooltip">Delete</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="tracker-empty-state">
                        <div class="tracker-empty-state-icon">
                            <i class="ph ph-list-plus"></i>
                        </div>
                        <h3>No Lists Yet</h3>
                        <p>Create your first creator list to start tracking and analyzing performance. You can either import an existing X list or build a manual list from scratch.</p>
                        <div class="tracker-empty-state-cta">
                            <button class="tracker-empty-state-btn" onclick="document.getElementById('new-list-name-input').focus()">
                                <i class="ph ph-plus"></i>
                                Create Your First List
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div id="edit-list-modal" class="tracker-modal" style="display: none;">
    <div class="tracker-modal-content">
        <div class="tracker-modal-header">
            <h3 class="tracker-modal-title">
                <i class="ph ph-pencil"></i>
                Edit Creator List
            </h3>
        </div>
        <div class="tracker-modal-body">
            <div class="form-group">
                <label for="new-creator-handle-input" class="tracker-form-label">Add Creator</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-creator-handle-input" class="tracker-form-input" placeholder="@username" style="flex: 1;">
                    <button id="add-creator-btn" class="tracker-secondary-button">
                        <i class="ph ph-plus"></i>
                        Add
                    </button>
                </div>
            </div>
            <div id="creators-list" class="creator-grid">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        <div class="tracker-modal-footer">
            <button id="close-edit-modal" class="tracker-secondary-button">Close</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="tracker-modal" style="display: none;">
    <div class="tracker-modal-content">
        <div class="tracker-modal-header">
            <h3 class="tracker-modal-title">
                <i class="ph ph-warning" style="color: #f87171;"></i>
                Delete List
            </h3>
        </div>
        <div class="tracker-modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Are you sure you want to delete this list? This action cannot be undone.</p>
            <p id="delete-list-name" style="color: var(--text-muted); font-weight: 600;"></p>
        </div>
        <div class="tracker-modal-footer">
            <button id="cancel-delete" class="tracker-secondary-button">Cancel</button>
            <button id="confirm-delete" class="tracker-premium-button" style="background: #ef4444;">
                <i class="ph ph-trash"></i>
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Hidden data for charts -->
{% if performance_chart_data %}
<script type="application/json" id="chart-data">{{ performance_chart_data|tojson|safe }}</script>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{{ url_for('static', filename='scripts/niche_radar.js') }}"></script>
<script>
// Initialize with data from backend
(function() {
    'use strict';

    // Wait for the external script to load and initialize
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof initializeNicheRadar === 'function') {
            initializeNicheRadar();
        }
    });
})();
</script>
{% endblock %}
