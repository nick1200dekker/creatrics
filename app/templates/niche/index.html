{% extends "base.html" %}

{% block title %}Niche Radar - Creatrics{% endblock %}

{% block seo_meta %}
<meta name="description" content="Analyze trending content and track creators in your niche with AI-powered insights. Discover what's hot on your timeline and optimize your content strategy with Niche Radar.">
<meta name="keywords" content="niche analysis, creator tracking, content trends, social media analytics, X analytics, creator insights">
{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/niche_radar.css') }}">
{% endblock %}

{% block content %}
<div class="content-panel">
    <div class="niche-radar-wrapper">
        <!-- Header -->
        <div class="niche-radar-header">
            <h1 class="niche-radar-title">
                <i class="ph-bold ph-crosshair"></i>
                <span>Niche Radar</span>
            </h1>
        </div>

        <!-- Content Area -->
        <div class="niche-radar-content">
            <!-- Progress Section (hidden by default, shown during analysis) -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-card">
                    <div class="progress-header">
                        <div class="progress-icon">
                            <i class="ph ph-spinner spin"></i>
                        </div>
                        <h2 class="progress-title">Analyzing Your Niche</h2>
                        <p class="progress-subtitle">This may take a moment while we analyze trending content...</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Panel - Always Visible -->
            <div id="analytics-panel" class="analytics-panel" style="display: block !important;">
                {% if latest_analysis %}
                <!-- Hot on Timeline -->
                {% if hot_on_timeline %}
                <div class="main-panel">
                    <div class="panel-header">
                        <div class="panel-controls">
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="list-dropdown-trigger">
                                    <span id="selected-list-text">
                                        {% if default_list %}{{ default_list }}{% else %}Choose a list...{% endif %}
                                    </span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="list-dropdown-menu">
                                    {% if creator_lists %}
                                        {% for list in creator_lists %}
                                        <div class="dropdown-option {% if default_list == list.name %}selected{% endif %}" data-value="{{ list.name }}">
                                            {{ list.name }}
                                        </div>
                                        {% endfor %}
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-option create-new" data-value="">
                                            <i class="ph ph-plus-circle"></i>
                                            <span>Add X List</span>
                                        </div>
                                    {% else %}
                                        <div class="dropdown-option create-new" data-value="">
                                            <i class="ph ph-plus-circle"></i>
                                            <span>Add X List</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="time-range-dropdown-trigger">
                                    <span id="selected-time-range-text">Last 24 Hours</span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="time-range-dropdown-menu">
                                    <div class="dropdown-option selected" data-value="24h">Last 24 Hours</div>
                                    <div class="dropdown-option" data-value="48h">Last 48 Hours</div>
                                    <div class="dropdown-option" data-value="72h">Last 72 Hours</div>
                                    <div class="dropdown-option" data-value="1w">Last Week</div>
                                </div>
                            </div>
                            
                            <button id="analyze-button" class="primary-btn" {% if not creator_lists %}disabled{% endif %}>
                                <i class="ph ph-arrows-clockwise"></i>
                                Analyze
                            </button>
                        </div>
                    </div>

                    <!-- Last Refresh Indicator -->
                    {% if timestamp %}
                    <div class="last-refresh-indicator" data-timestamp="{{ timestamp }}">
                        <i class="ph ph-clock-clockwise"></i>
                        <span class="refresh-label">Last refreshed:</span>
                        <span class="refresh-time" id="lastRefreshTime"></span>
                        <span class="refresh-note">Â· Engagement stats are from this snapshot</span>
                    </div>
                    {% endif %}

                    <div class="panel-content">
                        <div class="hot-timeline">
                            {{ hot_on_timeline|safe }}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="main-panel">
                    <div class="panel-header">
                        <div class="panel-title-section">
                            <h3 class="panel-title">
                                <i class="ph ph-trend-up"></i>
                                Trending in Your Niche
                            </h3>
                        </div>
                        <div class="panel-controls">
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="list-dropdown-trigger-empty">
                                    <span id="selected-list-text-empty">
                                        {% if default_list %}{{ default_list }}{% else %}Choose a list...{% endif %}
                                    </span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="list-dropdown-menu-empty">
                                    {% if creator_lists %}
                                        {% for list in creator_lists %}
                                        <div class="dropdown-option {% if default_list == list.name %}selected{% endif %}" data-value="{{ list.name }}">
                                            {{ list.name }}
                                        </div>
                                        {% endfor %}
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-option create-new" data-value="">
                                            <i class="ph ph-plus-circle"></i>
                                            <span>Add X List</span>
                                        </div>
                                    {% else %}
                                        <div class="dropdown-option create-new" data-value="">
                                            <i class="ph ph-plus-circle"></i>
                                            <span>Add X List</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="time-range-dropdown-trigger-empty">
                                    <span id="selected-time-range-text-empty">Last 24 Hours</span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="time-range-dropdown-menu-empty">
                                    <div class="dropdown-option selected" data-value="24h">Last 24 Hours</div>
                                    <div class="dropdown-option" data-value="48h">Last 48 Hours</div>
                                    <div class="dropdown-option" data-value="72h">Last 72 Hours</div>
                                    <div class="dropdown-option" data-value="1w">Last Week</div>
                                </div>
                            </div>
                            
                            <button id="analyze-button-empty" class="primary-btn" {% if not creator_lists %}disabled{% endif %}>
                                <i class="ph ph-arrows-clockwise"></i>
                                Analyze
                            </button>
                        </div>
                    </div>
                    
                    <div class="panel-content">
                        <div class="hot-timeline">
                            <p>Click "Analyze" to generate insights from your creator lists.</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Charts -->
                {% if performance_chart_data %}
                <div class="charts-section">
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">
                                    <i class="ph ph-chat-circle-text"></i>
                                </div>
                                <h3 class="chart-title">Tweets Count</h3>
                            </div>
                            <div class="chart-container">
                                <div id="tweets-chart" style="height: 100%;"></div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">
                                    <i class="ph ph-heart"></i>
                                </div>
                                <h3 class="chart-title">Total Likes</h3>
                            </div>
                            <div class="chart-container">
                                <div id="likes-chart" style="height: 100%;"></div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">
                                    <i class="ph ph-eye"></i>
                                </div>
                                <h3 class="chart-title">Total Views</h3>
                            </div>
                            <div class="chart-container">
                                <div id="views-chart" style="height: 100%;"></div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-icon">
                                    <i class="ph ph-percent"></i>
                                </div>
                                <h3 class="chart-title">Engagement Rate</h3>
                            </div>
                            <div class="chart-container">
                                <div id="engagement-chart" style="height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Top Performing Posts -->
                {% if top_tweets %}
                <div class="top-posts-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="ph ph-fire"></i>
                            Top Performing Posts
                        </h2>
                    </div>
                    <div class="posts-grid">
                        {% for tweet in top_tweets[:40] %}
                        <div class="post-card">
                            <!-- X Logo (required by brand guidelines) -->
                            <img src="{{ url_for('static', filename='img/templates/logo-black.png') }}"
                                 alt="X" class="post-x-logo">
                            <img src="{{ url_for('static', filename='img/templates/logo-white.png') }}"
                                 alt="X" class="post-x-logo">

                            <div class="post-header">
                                <div class="post-avatar">
                                    {% if tweet.profile_image_url and tweet.profile_image_url != '' %}
                                    <img src="{{ tweet.profile_image_url }}"
                                         alt="@{{ tweet.creator }}"
                                         onload="this.classList.remove('error')"
                                         onerror="this.classList.add('error')">
                                    <div class="post-avatar-fallback">
                                        <i class="ph ph-user"></i>
                                    </div>
                                    {% else %}
                                    <div class="post-avatar-fallback" style="display: flex;">
                                        <i class="ph ph-user"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="post-author">
                                    <div class="post-name">{{ tweet.name or tweet.creator }}</div>
                                    <div class="post-handle">@{{ tweet.creator }}</div>
                                </div>
                            </div>

                            <div class="post-content">
                                {{ tweet.text }}
                            </div>

                            {% if tweet.media %}
                            <div class="post-media">
                                {% if tweet.media.photo %}
                                <div class="post-photos">
                                    {% for photo in tweet.media.photo %}
                                    <div class="post-photo">
                                        <img src="{{ photo.media_url_https }}" alt="Post image" class="post-image" loading="lazy"
                                             onerror="this.style.display='none'">
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                {% if tweet.media.video %}
                                <div class="post-videos">
                                    {% for video in tweet.media.video %}
                                    <div class="post-video">
                                        {% if video.variants %}
                                            {% set mp4_variant = video.variants | selectattr('content_type', 'equalto', 'video/mp4') | list | last %}
                                            {% if mp4_variant %}
                                            <video controls class="post-video-player" poster="{{ video.media_url_https }}">
                                                <source src="{{ mp4_variant.url }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                            {% else %}
                                            <img src="{{ video.media_url_https }}" alt="Video thumbnail" class="post-video-thumb" loading="lazy"
                                                 onerror="this.style.display='none'">
                                            {% endif %}
                                        {% else %}
                                        <img src="{{ video.media_url_https }}" alt="Video thumbnail" class="post-video-thumb" loading="lazy"
                                             onerror="this.style.display='none'">
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Timestamp and Views -->
                            {% if tweet.created_at %}
                            <div class="post-timestamp-full" data-timestamp="{{ tweet.created_at }}" data-views="{{ tweet.engagement.views }}">
                                <a href="https://x.com/{{ tweet.creator }}/status/{{ tweet.tweet_id }}" target="_blank" rel="noopener noreferrer" class="post-time-link">
                                    <span class="post-time"></span>
                                </a>
                                <span class="post-views">
                                    <span class="post-views-count">{{ tweet.engagement.views }}</span> Views
                                </span>
                            </div>
                            {% endif %}

                            <!-- Engagement Stats -->
                            <div class="post-stats">
                                <div class="stat">
                                    <i class="ph ph-chat-centered"></i>
                                    <span>{{ tweet.engagement.replies or 0 }}</span>
                                </div>
                                <div class="stat">
                                    <i class="ph ph-repeat"></i>
                                    <span>{{ tweet.engagement.retweets or 0 }}</span>
                                </div>
                                <div class="stat">
                                    <i class="ph ph-heart"></i>
                                    <span>{{ tweet.engagement.likes or 0 }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <!-- Empty Analytics State -->
                <div class="main-panel">
                    <div class="panel-header">
                        <div class="panel-title-section">
                            <h3 class="panel-title">
                                <i class="ph ph-trend-up"></i>
                                Trending in Your Niche
                            </h3>
                        </div>
                        <div class="panel-controls">
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="list-dropdown-trigger-default">
                                    <span id="selected-list-text-default">
                                        {% if default_list %}{{ default_list }}{% else %}Choose a list...{% endif %}
                                    </span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="list-dropdown-menu-default">
                                    {% if creator_lists %}
                                        {% for list in creator_lists %}
                                        <div class="dropdown-option {% if default_list == list.name %}selected{% endif %}" data-value="{{ list.name }}">
                                            {{ list.name }}
                                        </div>
                                        {% endfor %}
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-option create-new" data-value="">
                                            <i class="ph ph-plus-circle"></i>
                                            <span>Add X List</span>
                                        </div>
                                    {% else %}
                                        <div class="dropdown-option create-new" data-value="">
                                            <i class="ph ph-plus-circle"></i>
                                            <span>Add X List</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="dropdown">
                                <div class="dropdown-trigger" id="time-range-dropdown-trigger-default">
                                    <span id="selected-time-range-text-default">Last 24 Hours</span>
                                    <i class="ph ph-caret-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="time-range-dropdown-menu-default">
                                    <div class="dropdown-option selected" data-value="24h">Last 24 Hours</div>
                                    <div class="dropdown-option" data-value="48h">Last 48 Hours</div>
                                    <div class="dropdown-option" data-value="72h">Last 72 Hours</div>
                                    <div class="dropdown-option" data-value="1w">Last Week</div>
                                </div>
                            </div>
                            
                            <button id="analyze-button-default" class="primary-btn" {% if not creator_lists %}disabled{% endif %}>
                                <i class="ph ph-arrows-clockwise"></i>
                                Analyze
                            </button>
                        </div>
                    </div>
                    
                    <div class="empty-state">
                        <i class="ph ph-chart-line empty-icon"></i>
                        <div class="empty-title">No Analytics Data</div>
                        <div class="empty-text">
                            {% if not creator_lists %}
                                Create a list first to start analyzing creators.
                            {% else %}
                                Select a list and click "Analyze" to generate comprehensive insights from your tracked creators.
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- Create X List Modal -->
<div id="create-list-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ph ph-plus-circle"></i>
                Add X List
            </h3>
            <button class="modal-close" id="close-create-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="simple-list-name">List Name</label>
                <input type="text" id="simple-list-name" class="form-input" placeholder="Enter list name...">
            </div>
            <div class="form-group">
                <label for="simple-x-list-id">X List ID</label>
                <input type="text" id="simple-x-list-id" class="form-input" placeholder="Enter X List ID...">
            </div>
            <div class="info-box" style="margin-top: 1rem;">
                <i class="ph ph-info"></i>
                <div class="info-content">
                    <div class="info-title">How to find your X List ID</div>
                    <div class="info-text">Go to your list on X and copy the last part from the URL.<br>For example: x.com/i/lists/<strong>1234567890</strong></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-create-btn" class="secondary-btn">Cancel</button>
            <button id="simple-create-btn" class="primary-btn">
                <i class="ph ph-plus"></i>
                Add X List
            </button>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div id="edit-list-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="ph ph-pencil"></i>
                Edit Creator List
            </h3>
            <button class="modal-close" id="close-edit-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-creator-handle-input">Add Creator</label>
                <div style="display: flex; gap: 0.75rem;">
                    <input type="text" id="new-creator-handle-input" class="form-input" placeholder="@username" style="flex: 1;">
                    <button id="add-creator-btn" class="primary-btn">
                        <i class="ph ph-plus"></i>
                        Add
                    </button>
                </div>
            </div>
            <div id="creators-list" class="creator-grid">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        <div class="modal-footer">
            <button id="close-edit-modal-btn" class="secondary-btn">Close</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" style="color: #EF4444;">
                <i class="ph ph-warning"></i>
                Delete List
            </h3>
            <button class="modal-close" id="close-delete-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-primary); margin-bottom: 1rem;">Are you sure you want to delete this list? This action cannot be undone.</p>
            <p id="delete-list-name" style="color: var(--text-secondary); font-weight: 600;"></p>
        </div>
        <div class="modal-footer">
            <button id="cancel-delete" class="secondary-btn">Cancel</button>
            <button id="confirm-delete" class="primary-btn" style="background: #EF4444;">
                <i class="ph ph-trash"></i>
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Hidden data for charts -->
{% if performance_chart_data %}
<script type="application/json" id="chart-data">{{ performance_chart_data|tojson|safe }}</script>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{{ url_for('static', filename='scripts/niche_radar.js') }}"></script>
{% endblock %}