{% extends "base.html" %}

{% block title %}Niche Radar - Creatrics{% endblock %}

{% block seo_meta %}
<meta name="description" content="Analyze trending content and track creators in your niche with AI-powered insights. Discover what's hot on your timeline and optimize your content strategy with Niche Radar.">
<meta name="keywords" content="niche analysis, creator tracking, content trends, social media analytics, X analytics, creator insights">
{% endblock %}

{% block additional_styles %}
<style>
/* Niche Radar styles - FIXED VERSION WITH CONSISTENT SPACING */
/* Remove duplicate variable definitions - use base.html variables */

/* Utility classes */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Premium card styling */
.tracker-premium-card {
    background-color: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    overflow: hidden;
}

/* Button styles - tracker specific */
.tracker-secondary-button {
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 0 12px;
    height: var(--button-height);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
    cursor: pointer;
    text-decoration: none;
    font-size: 0.875rem;
    gap: 8px;
}

.tracker-secondary-button:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
}

.tracker-premium-button {
    background: var(--teal-gradient);
    color: #1a1a1a;
    font-weight: 600;
    border: none;
    box-shadow: 0 4px 12px rgba(32, 215, 215, 0.3);
    padding: 0 16px;
    height: var(--button-height);
    border-radius: 8px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 120px;
    justify-content: center;
}

.tracker-premium-button:hover {
    background: linear-gradient(135deg, #19c6c6 0%, #107878 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(32, 215, 215, 0.4);
}

.tracker-premium-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 4px 12px rgba(32, 215, 215, 0.2);
}

/* Analyzing state */
.tracker-premium-button.analyzing {
    background: #4a5568 !important;
    color: #a0aec0 !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
    transform: none !important;
    box-shadow: none !important;
}

.tracker-premium-button.analyzing:hover {
    background: #4a5568 !important;
    color: #a0aec0 !important;
    transform: none !important;
    box-shadow: none !important;
}

/* Tooltip System */
.tracker-tooltip {
    position: absolute;
    bottom: -32px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--card-bg);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    border: 1px solid var(--border-color);
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: 10;
    pointer-events: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    color: var(--text-primary);
}

.tracker-tooltip-container {
    position: relative;
}

.tracker-tooltip-container:hover .tracker-tooltip {
    opacity: 1;
    visibility: visible;
}

/* View toggle buttons */
.tracker-view-toggle {
    display: flex;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
    height: var(--button-height);
}

.tracker-view-toggle-btn {
    background: transparent;
    border: none;
    padding: 0 16px;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    height: 100%;
    min-width: 100px;
    justify-content: center;
}

.tracker-view-toggle-btn:hover {
    background: rgba(255, 255, 255, 0.08);
    color: white;
}

.tracker-view-toggle-btn.active {
    background: var(--teal-gradient);
    color: #1a1a1a;
}

/* Section headers - FIXED spacing and consistency */
.tracker-section-header-with-controls {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 1rem;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.tracker-section-title-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 0;
    flex: 1;
}

.tracker-section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
}

.tracker-section-title i {
    color: var(--teal-primary);
    font-size: 1rem;
}

/* FIXED: Consistent spacing between form controls */
.tracker-section-controls {
    display: flex;
    align-items: flex-end;
    gap: 1rem;
    flex-shrink: 0;
    margin-left: auto;
}

/* FIXED: Form styling with consistent sizing matching reply-guy */
.tracker-form-input, .tracker-form-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    padding: 0 16px; /* Changed from 0 12px */
    font-size: 0.875rem;
    font-weight: 500;
    height: var(--button-height);
    transition: all 0.2s ease;
    min-width: 200px; /* Matching reply-guy */
    cursor: pointer;
    appearance: none;
    font-family: inherit;
}

.tracker-form-input:focus, .tracker-form-select:focus {
    outline: none;
    border-color: var(--teal-primary);
    box-shadow: 0 0 0 3px rgba(32, 215, 215, 0.2);
    background: rgba(255, 255, 255, 0.08);
}

.tracker-form-input::placeholder {
    color: var(--text-muted);
}

/* Form Labels with consistent spacing */
.tracker-form-label-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tracker-form-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    height: 1rem;
    line-height: 1rem;
}

.tracker-analyze-button-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tracker-analyze-button-group .tracker-form-label {
    opacity: 0;
    pointer-events: none;
    height: 1rem;
}

/* Hot Timeline Styling - FIXED SPACING */
.hot-timeline-container {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.hot-timeline {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    padding: 1rem;
    line-height: 1.6;
    font-size: 0.95rem;
    color: var(--text-secondary);
}

/* Timeline headers - AGGRESSIVE FIX FOR SPACING */
.hot-timeline h1,
.hot-timeline h2,
.hot-timeline h3,
.hot-timeline h4,
.hot-timeline h5,
.hot-timeline h6 {
    color: var(--text-primary) !important;
    font-weight: 600 !important;
    font-size: 1.1rem !important;
    margin: 1.5rem 0 0 0 !important; /* Space before headers, no space after */
    padding: 0 0 2px 0 !important; /* Minimal padding bottom for border */
    border-bottom: 1px solid rgba(32, 215, 215, 0.3) !important;
    line-height: 1.2 !important;
}

.hot-timeline h1:first-child,
.hot-timeline h2:first-child,
.hot-timeline h3:first-child,
.hot-timeline h4:first-child,
.hot-timeline h5:first-child,
.hot-timeline h6:first-child {
    margin-top: 0 !important;
}

/* AGGRESSIVE FIX: Tight spacing for all paragraphs in hot timeline */
.hot-timeline p {
    margin: 0.25rem 0 0.75rem 0 !important; /* Very small top margin */
    padding: 0 !important;
    color: var(--text-secondary);
    line-height: 1.6;
    font-size: 1rem;
}

/* Paragraphs immediately after headers get even tighter spacing */
.hot-timeline h1 + p,
.hot-timeline h2 + p,
.hot-timeline h3 + p,
.hot-timeline h4 + p,
.hot-timeline h5 + p,
.hot-timeline h6 + p {
    margin-top: 0.25rem !important; /* Minimal gap after headers */
}

/* Last paragraph needs no bottom margin */
.hot-timeline p:last-child {
    margin-bottom: 0 !important;
}

/* Also target any potential default styles from content */
.hot-timeline > :first-child {
    margin-top: 0 !important;
}

.hot-timeline > :last-child {
    margin-bottom: 0 !important;
}

.hot-timeline strong {
    color: var(--text-primary);
    font-weight: 600;
}

/* Blue @mentions styling */
.hot-timeline .mention,
.mention {
    color: #1DA1F2;
    font-weight: 600;
    text-decoration: none;
    transition: color 0.2s ease;
}

.hot-timeline .mention:hover,
.mention:hover {
    color: #1a91da;
    text-decoration: underline;
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.chart-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.chart-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.chart-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1rem;
}

.chart-icon {
    width: 40px;
    height: 40px;
    background: var(--teal-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: #1a1a1a;
    box-shadow: 0 4px 12px rgba(32, 215, 215, 0.3);
}

.chart-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.chart-container {
    height: 300px;
    border-radius: 8px;
    overflow: hidden;
}

/* Lists creation form - FIXED with consistent spacing */
.tracker-creation-form {
    margin-bottom: 0;
}

.tracker-form-inputs-row,
html body .tracker-form-inputs-row {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
    flex-wrap: wrap;
    width: 100%;
}

.tracker-form-inputs-row > div,
html body .tracker-form-inputs-row > div {
    flex: 1;
    min-width: 200px;
}

/* Make X List ID input take more space */
#x-list-id-container,
html body #x-list-id-container {
    min-width: 260px;
    flex: 1.5;
}

.tracker-form-inputs-row .tracker-form-input,
html body .tracker-form-inputs-row .tracker-form-input {
    width: 100%;
}

.x-list-id-container,
html body .x-list-id-container {
    display: none !important;
    width: 100%;
}

.x-list-id-container.show,
html body .x-list-id-container.show {
    display: block !important;
}

.x-list-help-container,
html body .x-list-help-container {
    margin-top: 12px;
    display: none !important;
}

.x-list-help-container.show,
html body .x-list-help-container.show {
    display: block !important;
}

.x-list-help,
html body .x-list-help {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
    padding: 12px;
}

.x-list-help i,
html body .x-list-help i {
    color: #3b82f6;
    font-size: 20px;
}

.x-list-help-content,
html body .x-list-help-content {
    flex: 1;
}

.x-list-help-title,
html body .x-list-help-title {
    font-weight: 600;
    margin-bottom: 4px;
}

.x-list-help-text,
html body .x-list-help-text {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.4;
}

/* Create button alignment */
.tracker-create-btn {
    background: var(--teal-gradient);
    color: #1a1a1a;
    font-weight: 600;
    border: none;
    box-shadow: 0 4px 12px rgba(32, 215, 215, 0.3);
    padding: 0 20px;
    height: 40px;
    border-radius: 8px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 120px;
    justify-content: center;
    white-space: nowrap;
    flex-shrink: 0;
}

.tracker-create-btn:hover {
    background: linear-gradient(135deg, #19c6c6 0%, #107878 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(32, 215, 215, 0.4);
}

.tracker-create-btn:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(32, 215, 215, 0.3);
}

.x-list-help {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
    padding: 12px;
}

.x-list-help i {
    color: #3b82f6;
    font-size: 1rem;
    margin-top: 2px;
    flex-shrink: 0;
}

.x-list-help-content {
    flex: 1;
}

.x-list-help-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 4px 0;
}

.x-list-help-text {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.4;
}

/* List Items */
.tracker-list-item {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin: 1.5rem 0;
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.tracker-list-item:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
    border-color: rgba(32, 215, 215, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.tracker-list-item-content {
    padding: 1rem 1.25rem;
}

.tracker-list-item-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 0;
}

.tracker-list-info {
    flex: 1;
    min-width: 0;
}

.tracker-list-name-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.tracker-list-name {
    color: var(--text-primary);
    font-weight: 600;
    margin: 0;
    font-size: 1rem;
    line-height: 1.2;
}

.tracker-list-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
}

.tracker-list-type-badge.x_list,
.tracker-list-type-badge.x-list {
    background: rgba(29, 161, 242, 0.15);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(29, 161, 242, 0.3);
}

.tracker-list-type-badge.manual {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.tracker-list-metadata {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.tracker-metadata-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.tracker-metadata-item i {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.tracker-list-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

/* List action buttons */
.tracker-list-action-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1rem;
    position: relative;
}

.tracker-list-action-btn:hover {
    background: var(--teal-primary);
    color: #1a1a1a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(32, 215, 215, 0.3);
}

.tracker-list-action-btn.delete:hover {
    background: #ef4444;
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.tracker-list-action-btn.refresh:hover {
    background: #3b82f6;
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Panel visibility */
.analytics-panel {
    display: block;
}

.lists-panel {
    display: none;
}

.lists-panel.active {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.analytics-panel.hidden {
    display: none;
}

/* Empty States */
.tracker-empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.005) 100%);
}

.tracker-empty-state-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, rgba(32, 215, 215, 0.1) 0%, rgba(32, 215, 215, 0.05) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed rgba(32, 215, 215, 0.3);
}

.tracker-empty-state-icon i {
    font-size: 2rem;
    color: var(--teal-primary);
}

.tracker-empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

.tracker-empty-state p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    max-width: 400px;
    margin: 0 auto;
    line-height: 1.5;
}

.tracker-empty-state-cta {
    margin-top: 2rem;
    display: flex;
    justify-content: center;
    gap: 12px;
}

.tracker-empty-state-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: rgba(32, 215, 215, 0.1);
    color: var(--teal-primary);
    border: 1px solid rgba(32, 215, 215, 0.3);
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.tracker-empty-state-btn:hover {
    background: rgba(32, 215, 215, 0.2);
    transform: translateY(-1px);
    text-decoration: none;
    color: var(--teal-primary);
}

/* Modals */
.tracker-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.tracker-modal-content {
    background-color: var(--card-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.tracker-modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background-color: rgba(0, 0, 0, 0.1);
}

.tracker-modal-title {
    font-size: 1rem;
    font-weight: 600;
    color: white;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tracker-modal-body {
    padding: 1.5rem;
}

.tracker-modal-footer {
    padding: 1.25rem 1.5rem;
    border-top: 1px solid var(--border-color);
    background-color: rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* Creator Grid */
.creator-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
    margin-top: 1rem;
}

.creator-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
    cursor: pointer;
}

.creator-card:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
}

.creator-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.creator-handle {
    color: var(--teal-primary);
    font-weight: 600;
    font-size: 0.875rem;
}

/* Loading States */
.tracker-loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--teal-primary);
    animation: spin 1s linear infinite;
}

.tracker-premium-button .tracker-loading-spinner {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: currentColor;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 6px;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Toast Notifications */
.tracker-toast-container {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 1100;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.tracker-toast {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 16px;
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    transform: translateX(400px);
    transition: all 0.3s ease;
}

.tracker-toast.show {
    transform: translateX(0);
}

.tracker-toast.success {
    border-left: 4px solid #4ade80;
}

.tracker-toast.error {
    border-left: 4px solid #f87171;
}

.tracker-toast.info {
    border-left: 4px solid #60a5fa;
}

.tracker-toast.warning {
    border-left: 4px solid #fbbf24;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .tracker-section-header-with-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .tracker-section-controls {
        width: 100%;
        justify-content: flex-start;
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }
    
    .tracker-form-label-group {
        width: 100%;
    }
    
    .tracker-form-input, .tracker-form-select {
        width: 100%;
        min-width: 0;
    }
    
    .tracker-analyze-button-group {
        align-self: stretch;
        width: 100%;
    }
    
    .tracker-analyze-button-group .tracker-form-label {
        opacity: 1;
    }
    
    .tracker-premium-button {
        width: 100%;
        justify-content: center;
    }
    
    .tracker-view-toggle {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .tracker-form-inputs-row {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .tracker-form-inputs-row > div {
        width: 100%;
        min-width: 0;
    }
    
    #x-list-id-container {
        min-width: 0;
    }
    
    .tracker-create-btn {
        width: 100%;
        justify-content: center;
    }
    
    .tracker-list-item-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .tracker-list-actions {
        align-self: flex-end;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-card {
        padding: 1rem;
    }
    
    .tracker-modal-content {
        width: 95%;
        margin: 1rem;
    }
    
    .creator-grid {
        grid-template-columns: 1fr;
    }
    
    .tracker-empty-state {
        padding: 3rem 1.5rem;
    }
    
    .tracker-empty-state-cta {
        flex-direction: column;
        align-items: center;
    }
    
    .hot-timeline h1,
    .hot-timeline h2,
    .hot-timeline h3,
    .hot-timeline h4,
    .hot-timeline h5,
    .hot-timeline h6 {
        font-size: 1.05rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="flex-1 space-y-4 w-full">
    <!-- Header -->
    <div class="tracker-premium-card">
        <div class="p-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="ph ph-radar text-teal-primary mr-3"></i>
                Niche Radar
            </h2>
            <div class="flex space-x-3">
                <div class="tracker-view-toggle">
                    <button id="analytics-view-btn" class="tracker-view-toggle-btn active">
                        <i class="ph ph-chart-line"></i>
                        Analytics
                    </button>
                    <button id="lists-view-btn" class="tracker-view-toggle-btn">
                        <i class="ph ph-list-plus"></i>
                        Lists
                    </button>
                </div>
                <a href="{{ url_for('teams.teams_dashboard') }}" class="tracker-secondary-button">
                    <i class="ph ph-house"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Analytics Panel -->
    <div id="analytics-panel" class="analytics-panel">
        {% if latest_analysis %}
        <!-- Hot on Timeline -->
        {% if hot_on_timeline %}
        <div class="hot-timeline-container">
            <div class="tracker-section-header-with-controls">
                <div class="tracker-section-title-info">
                    <h3 class="tracker-section-title">
                        <i class="ph ph-trend-up"></i>
                        What's Hot in Your Niche Right Now
                    </h3>
                </div>
                <div class="tracker-section-controls">
                    <div class="tracker-form-label-group">
                        <label for="list-select" class="tracker-form-label">List Name</label>
                        <select id="list-select" class="tracker-form-select">
                            {% if creator_lists %}
                                {% for list in creator_lists %}
                                    <option value="{{ list.name }}" {% if default_list == list.name %}selected{% endif %}>
                                        {{ list.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="">No lists available</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="tracker-form-label-group">
                        <label for="time-range-select" class="tracker-form-label">Time Range</label>
                        <select id="time-range-select" class="tracker-form-select">
                            <option value="24h">Last 24 Hours</option>
                            <option value="48h">Last 48 Hours</option>
                            <option value="72h">Last 72 Hours</option>
                            <option value="1w">Last Week</option>
                        </select>
                    </div>
                    
                    <div class="tracker-analyze-button-group">
                        <label for="analyze-button" class="tracker-form-label">Action</label>
                        <button id="analyze-button" class="tracker-premium-button" {% if not creator_lists %}disabled{% endif %}>
                            <i class="ph ph-arrows-clockwise"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="hot-timeline">
                {{ hot_on_timeline|safe }}
            </div>
        </div>
        {% else %}
        <div class="hot-timeline-container">
            <div class="tracker-section-header-with-controls">
                <div class="tracker-section-title-info">
                    <h3 class="tracker-section-title">
                        <i class="ph ph-trend-up"></i>
                        What's Hot in Your Niche Right Now
                    </h3>
                </div>
                <div class="tracker-section-controls">
                    <div class="tracker-form-label-group">
                        <label for="list-select-2" class="tracker-form-label">List Name</label>
                        <select id="list-select-2" class="tracker-form-select">
                            {% if creator_lists %}
                                {% for list in creator_lists %}
                                    <option value="{{ list.name }}" {% if default_list == list.name %}selected{% endif %}>
                                        {{ list.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="">No lists available</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="tracker-form-label-group">
                        <label for="time-range-select-2" class="tracker-form-label">Time Range</label>
                        <select id="time-range-select-2" class="tracker-form-select">
                            <option value="24h">Last 24 Hours</option>
                            <option value="48h">Last 48 Hours</option>
                            <option value="72h">Last 72 Hours</option>
                            <option value="1w">Last Week</option>
                        </select>
                    </div>
                    
                    <div class="tracker-analyze-button-group">
                        <label for="analyze-button-2" class="tracker-form-label">Action</label>
                        <button id="analyze-button-2" class="tracker-premium-button" {% if not creator_lists %}disabled{% endif %}>
                            <i class="ph ph-arrows-clockwise"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="hot-timeline">
                <p>Click "Analyze" to generate insights from your creator lists.</p>
            </div>
        </div>
        {% endif %}

        <!-- Charts -->
        {% if performance_chart_data %}
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-chat-circle-text"></i>
                    </div>
                    <h3 class="chart-title">Tweets Count</h3>
                </div>
                <div class="chart-container">
                    <div id="tweets-chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-heart"></i>
                    </div>
                    <h3 class="chart-title">Total Likes</h3>
                </div>
                <div class="chart-container">
                    <div id="likes-chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-eye"></i>
                    </div>
                    <h3 class="chart-title">Total Views</h3>
                </div>
                <div class="chart-container">
                    <div id="views-chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="ph ph-percent"></i>
                    </div>
                    <h3 class="chart-title">Engagement Rate</h3>
                </div>
                <div class="chart-container">
                    <div id="engagement-chart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        {% endif %}
        {% else %}
        <!-- Empty Analytics State -->
        <div class="hot-timeline-container">
            <div class="tracker-section-header-with-controls">
                <div class="tracker-section-title-info">
                    <h3 class="tracker-section-title">
                        <i class="ph ph-trend-up"></i>
                        What's Hot in Your Niche Right Now
                    </h3>
                </div>
                <div class="tracker-section-controls">
                    <div class="tracker-form-label-group">
                        <label for="list-select-3" class="tracker-form-label">List Name</label>
                        <select id="list-select-3" class="tracker-form-select">
                            {% if creator_lists %}
                                {% for list in creator_lists %}
                                    <option value="{{ list.name }}" {% if default_list == list.name %}selected{% endif %}>
                                        {{ list.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="">No lists available</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="tracker-form-label-group">
                        <label for="time-range-select-3" class="tracker-form-label">Time Range</label>
                        <select id="time-range-select-3" class="tracker-form-select">
                            <option value="24h">Last 24 Hours</option>
                            <option value="48h">Last 48 Hours</option>
                            <option value="72h">Last 72 Hours</option>
                            <option value="1w">Last Week</option>
                        </select>
                    </div>
                    
                    <div class="tracker-analyze-button-group">
                        <label for="analyze-button-3" class="tracker-form-label">Action</label>
                        <button id="analyze-button-3" class="tracker-premium-button" {% if not creator_lists %}disabled{% endif %}>
                            <i class="ph ph-arrows-clockwise"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="tracker-empty-state">
                <div class="tracker-empty-state-icon">
                    <i class="ph ph-chart-line"></i>
                </div>
                <h3>No Analytics Data</h3>
                <p>{% if not creator_lists %}Create a list first to start analyzing creators.{% else %}Select a list and click "Analyze" to generate comprehensive insights from your tracked creators.{% endif %}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Lists Management Panel -->
    <div id="lists-panel" class="lists-panel">
        <!-- Create New List Panel -->
        <div class="tracker-premium-card">
            <div class="p-4">
                <div class="tracker-section-header-with-controls">
                    <div class="tracker-section-title-info">
                        <h3 class="tracker-section-title">
                            <i class="ph ph-plus-circle"></i>
                            Create New List
                        </h3>
                    </div>
                </div>
                
                <div class="tracker-creation-form">
                    <div class="tracker-form-inputs-row">
                        <div>
                            <label for="new-list-type-select" class="sr-only">List type</label>
                            <select id="new-list-type-select" name="new-list-type" class="tracker-form-input">
                                <option value="x_list">X List</option>
                                <option value="manual">Manual List</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-list-name-input" class="sr-only">List name</label>
                            <input type="text" id="new-list-name-input" name="new-list-name" placeholder="Enter list name..." class="tracker-form-input">
                        </div>
                        <div id="x-list-id-container" class="x-list-id-container show">
                            <label for="x-list-id-input" class="sr-only">X List ID</label>
                            <input type="text" id="x-list-id-input" name="x-list-id" placeholder="Enter X List ID..." class="tracker-form-input">
                        </div>
                        <div>
                            <button id="create-list-btn" type="button" class="tracker-create-btn">
                                <i class="ph ph-plus"></i>
                                Create List
                            </button>
                        </div>
                    </div>
                    <div id="x-list-help-container" class="x-list-help-container show">
                        <div class="x-list-help">
                            <i class="ph ph-info"></i>
                            <div class="x-list-help-content">
                                <div class="x-list-help-title">How to find your List ID</div>
                                <div class="x-list-help-text">Go to your list on X and copy the last part from the URL.<br>For example: x.com/i/lists/<strong>1234567890</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Your Custom Lists Panel -->
        <div class="tracker-premium-card">
            <div class="p-4">
                <div class="tracker-section-header-with-controls">
                    <div class="tracker-section-title-info">
                        <h3 class="tracker-section-title">
                            <i class="ph ph-list-bullets"></i>
                            Your Creator Lists
                        </h3>
                    </div>
                </div>
                
                <div id="custom-lists-container">
                    {% if creator_lists %}
                        {% for list in creator_lists %}
                        <div class="tracker-list-item" data-list-name="{{ list.name }}">
                            <div class="tracker-list-item-content">
                                <div class="tracker-list-item-header">
                                    <div class="tracker-list-info">
                                        <div class="tracker-list-name-container">
                                            <h5 class="tracker-list-name">{{ list.name }}</h5>
                                            <span class="tracker-list-type-badge {{ 'x_list' if list.is_x_list else 'manual' }}">
                                                {% if list.is_x_list %}
                                                <i class="ph ph-link"></i>
                                                X List
                                                {% else %}
                                                <i class="ph ph-pencil"></i>
                                                Manual
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="tracker-list-metadata">
                                            <div class="tracker-metadata-item">
                                                <i class="ph ph-users"></i>
                                                <span>{{ list.creators|length }} creators</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tracker-list-actions">
                                        {% if list.is_x_list %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn update-x-list-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-arrows-clockwise"></i>
                                            <div class="tracker-tooltip">Update from X</div>
                                        </div>
                                        {% else %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn edit-list-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-pencil"></i>
                                            <div class="tracker-tooltip">Edit Creators</div>
                                        </div>
                                        {% endif %}
                                        {% if default_list != list.name %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn set-default-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-star"></i>
                                            <div class="tracker-tooltip">Set as Default</div>
                                        </div>
                                        {% endif %}
                                        <div class="tracker-tooltip-container tracker-list-action-btn delete delete-list-btn" data-list-name="{{ list.name }}">
                                            <i class="ph ph-trash"></i>
                                            <div class="tracker-tooltip">Delete</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="tracker-empty-state">
                        <div class="tracker-empty-state-icon">
                            <i class="ph ph-list-plus"></i>
                        </div>
                        <h3>No Lists Yet</h3>
                        <p>Create your first creator list to start tracking and analyzing performance. You can either import an existing X list or build a manual list from scratch.</p>
                        <div class="tracker-empty-state-cta">
                            <button class="tracker-empty-state-btn" onclick="document.getElementById('new-list-name-input').focus()">
                                <i class="ph ph-plus"></i>
                                Create Your First List
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div id="edit-list-modal" class="tracker-modal" style="display: none;">
    <div class="tracker-modal-content">
        <div class="tracker-modal-header">
            <h3 class="tracker-modal-title">
                <i class="ph ph-pencil"></i>
                Edit Creator List
            </h3>
        </div>
        <div class="tracker-modal-body">
            <div class="form-group">
                <label for="new-creator-handle-input" class="tracker-form-label">Add Creator</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-creator-handle-input" class="tracker-form-input" placeholder="@username" style="flex: 1;">
                    <button id="add-creator-btn" class="tracker-secondary-button">
                        <i class="ph ph-plus"></i>
                        Add
                    </button>
                </div>
            </div>
            <div id="creators-list" class="creator-grid">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        <div class="tracker-modal-footer">
            <button id="close-edit-modal" class="tracker-secondary-button">Close</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="tracker-modal" style="display: none;">
    <div class="tracker-modal-content">
        <div class="tracker-modal-header">
            <h3 class="tracker-modal-title">
                <i class="ph ph-warning" style="color: #f87171;"></i>
                Delete List
            </h3>
        </div>
        <div class="tracker-modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Are you sure you want to delete this list? This action cannot be undone.</p>
            <p id="delete-list-name" style="color: var(--text-muted); font-weight: 600;"></p>
        </div>
        <div class="tracker-modal-footer">
            <button id="cancel-delete" class="tracker-secondary-button">Cancel</button>
            <button id="confirm-delete" class="tracker-premium-button" style="background: #ef4444;">
                <i class="ph ph-trash"></i>
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Hidden data for charts -->
{% if performance_chart_data %}
<script type="application/json" id="chart-data">{{ performance_chart_data|tojson|safe }}</script>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// FIXED Creator Tracker JavaScript - Proper scope management and ApexCharts handling
(function() {
    'use strict';
    
    // Store references to event handlers at module level for cleanup
    let eventHandlers = {
        delegatedClick: null,
        modalClick: null,
        formKey: null,
        cleanup: null
    };
    
    // Wait for ApexCharts to be available
    function waitForApexCharts(callback) {
        if (typeof ApexCharts !== 'undefined') {
            callback();
        } else {
            setTimeout(() => waitForApexCharts(callback), 50);
        }
    }
    
    // Initialize tracker functionality
    function initializeTracker() {
        console.log('Creator Tracker: Starting initialization');
        
        // Global state - reset on each initialization
        window.TrackerState = {
            isAnalyzing: false,
            statusCheckInterval: null,
            charts: {},
            currentEditingList: null,
            currentDeletingList: null
        };
        
        // State manager
        if (!window.CreatorPal) window.CreatorPal = {};
        if (!window.CreatorPal.Tracker) window.CreatorPal.Tracker = {};
        
        if (!window.CreatorPal.Tracker.StateManager) {
            window.CreatorPal.Tracker.StateManager = {
                getProcessingState: function() {
                    try {
                        const state = sessionStorage.getItem('tracker_processing_state');
                        return state ? JSON.parse(state) : null;
                    } catch (e) {
                        return null;
                    }
                },
                
                setProcessingState: function(listName, isProcessing, statusMessage = '', progress = 0) {
                    const state = {
                        listName: listName,
                        isProcessing: isProcessing,
                        statusMessage: statusMessage,
                        progress: progress,
                        timestamp: Date.now()
                    };
                    try {
                        sessionStorage.setItem('tracker_processing_state', JSON.stringify(state));
                    } catch (e) {
                        console.error('Failed to save processing state:', e);
                    }
                },
                
                clearProcessingState: function() {
                    try {
                        sessionStorage.removeItem('tracker_processing_state');
                    } catch (e) {
                        console.error('Failed to clear processing state:', e);
                    }
                },
                
                isStateExpired: function(state) {
                    if (!state || !state.timestamp) return true;
                    const thirtyMinutes = 30 * 60 * 1000;
                    return (Date.now() - state.timestamp) > thirtyMinutes;
                }
            };
        }
        
        // Initialize all components
        init();
        
        function init() {
            console.log('Creator Tracker: Initializing');
            restoreProcessingState();
            setupEventListeners();
            setupViewToggle();
            setupListTypeToggle();
            
            // Wait for ApexCharts before setting up charts
            waitForApexCharts(() => {
                console.log('ApexCharts loaded, setting up charts');
                setupCharts();
            });
            
            console.log('Creator Tracker: Initialization complete');
        }
        
        function restoreProcessingState() {
            const savedState = window.CreatorPal.Tracker.StateManager.getProcessingState();
            if (savedState && savedState.isProcessing && !window.CreatorPal.Tracker.StateManager.isStateExpired(savedState)) {
                console.log('Restoring processing state for list:', savedState.listName);
                
                // Update all list selects
                document.querySelectorAll('[id^="list-select"]').forEach(select => {
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === savedState.listName) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                });
                
                setAnalyzingState(true, savedState.statusMessage);
                validateSavedProcessingState(savedState.listName);
            } else {
                setTimeout(checkForActiveProcessOnLoad, 100);
            }
        }
        
        function validateSavedProcessingState(listName) {
            console.log('Validating saved processing state for list:', listName);
            
            fetch('/niche/get-status')
                .then(response => response.json())
                .then(data => {
                    if (data.running && data.status === 'processing') {
                        console.log('Server confirms process is active');
                        startStatusPolling();
                    } else {
                        console.log('Server says no active process - clearing stale saved state');
                        window.CreatorPal.Tracker.StateManager.clearProcessingState();
                        setAnalyzingState(false);
                        
                        if (data.running) {
                            console.log('Found different active process');
                            const cleanMessage = data.step || 'Processing in progress...';
                            window.CreatorPal.Tracker.StateManager.setProcessingState('unknown', true, cleanMessage, data.progress || 10);
                            setAnalyzingState(true, cleanMessage);
                            startStatusPolling();
                            showToast('Found active analysis process, monitoring it', 'info');
                        } else {
                            setTimeout(checkForActiveProcessOnLoad, 100);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error validating saved state:', error);
                    console.log('Clearing saved state due to validation error');
                    window.CreatorPal.Tracker.StateManager.clearProcessingState();
                    setAnalyzingState(false);
                });
        }
        
        function checkForActiveProcessOnLoad() {
            fetch('/niche/get-status')
                .then(response => response.json())
                .then(data => {
                    if (data.running && data.status === 'processing') {
                        console.log('Found active process on load');
                        const cleanStatusMessage = data.step || 'Processing in progress...';
                        window.CreatorPal.Tracker.StateManager.setProcessingState('unknown', true, cleanStatusMessage, data.progress || 10);
                        setAnalyzingState(true, cleanStatusMessage);
                        startStatusPolling();
                        console.log('Resumed monitoring active process silently');
                    } else {
                        console.log('No active processes found');
                    }
                })
                .catch(error => {
                    console.log('No active processes found or connection error');
                });
        }
        
        function setAnalyzingState(analyzing, statusMessage = '') {
            // Update all analyze buttons
            document.querySelectorAll('[id^="analyze-button"]').forEach(button => {
                window.TrackerState.isAnalyzing = analyzing;
                
                if (analyzing) {
                    button.classList.add('analyzing');
                    button.disabled = true;
                    button.innerHTML = '<div class="tracker-loading-spinner"></div><span>Analyzing...</span>';
                } else {
                    button.classList.remove('analyzing');
                    button.disabled = false;
                    button.innerHTML = '<i class="ph ph-arrows-clockwise"></i><span>Analyze</span>';
                }
            });
            console.log('Button state updated:', analyzing ? 'analyzing' : 'normal');
        }
        
        // Define event handlers at module level
        eventHandlers.delegatedClick = function(e) {
            const target = e.target.closest('[data-list-name]');
            if (!target) return;
            
            const listName = target.dataset.listName;
            
            if (target.classList.contains('set-default-btn')) {
                setDefaultList(listName);
            } else if (target.classList.contains('edit-list-btn')) {
                editList(listName);
            } else if (target.classList.contains('update-x-list-btn')) {
                updateXList(listName);
            } else if (target.classList.contains('delete-list-btn')) {
                confirmDeleteList(listName);
            }
        };
        
        eventHandlers.modalClick = function(e) {
            if (e.target.classList.contains('tracker-modal')) {
                hideModal(e.target.id);
            }
        };
        
        eventHandlers.formKey = function(e) {
            if (e.key === 'Enter') {
                if (e.target.id === 'new-creator-handle-input') {
                    addCreator();
                } else if (e.target.closest('.tracker-creation-form')) {
                    createList();
                }
            }
        };
        
        function setupEventListeners() {
            console.log('Setting up event listeners');
            
            // Remove old event listeners first
            document.removeEventListener('click', eventHandlers.delegatedClick);
            document.removeEventListener('click', eventHandlers.modalClick);
            document.removeEventListener('keydown', eventHandlers.formKey);
            
            // Handle all analyze buttons
            document.querySelectorAll('[id^="analyze-button"]').forEach(button => {
                button.removeEventListener('click', handleAnalyze);
                button.addEventListener('click', handleAnalyze);
            });
            
            const createListBtn = document.getElementById('create-list-btn');
            if (createListBtn) {
                createListBtn.removeEventListener('click', createList);
                createListBtn.addEventListener('click', createList);
            }
            
            const closeEditModal = document.getElementById('close-edit-modal');
            if (closeEditModal) {
                closeEditModal.removeEventListener('click', closeEditModalHandler);
                closeEditModal.addEventListener('click', closeEditModalHandler);
            }
            
            const addCreatorBtn = document.getElementById('add-creator-btn');
            if (addCreatorBtn) {
                addCreatorBtn.removeEventListener('click', addCreator);
                addCreatorBtn.addEventListener('click', addCreator);
            }
            
            const cancelDelete = document.getElementById('cancel-delete');
            if (cancelDelete) {
                cancelDelete.removeEventListener('click', cancelDeleteHandler);
                cancelDelete.addEventListener('click', cancelDeleteHandler);
            }
            
            const confirmDelete = document.getElementById('confirm-delete');
            if (confirmDelete) {
                confirmDelete.removeEventListener('click', deleteList);
                confirmDelete.addEventListener('click', deleteList);
            }
            
            // Add new event listeners
            document.addEventListener('click', eventHandlers.delegatedClick);
            document.addEventListener('click', eventHandlers.modalClick);
            document.addEventListener('keydown', eventHandlers.formKey);
            
            console.log('Event listeners setup complete');
        }
        
        // Event handler functions
        function closeEditModalHandler() {
            hideModal('edit-list-modal');
        }
        
        function cancelDeleteHandler() {
            hideModal('delete-modal');
        }
        
        function handleAnalyze() {
            console.log('Analyze button clicked');
            
            if (window.TrackerState.isAnalyzing) {
                console.log('Already analyzing, ignoring click');
                return;
            }
            
            // Get the first available select values (they should all be synced)
            const listSelect = document.querySelector('[id^="list-select"]');
            const timeRange = document.querySelector('[id^="time-range-select"]');
            
            const selectedList = listSelect?.value;
            const selectedTimeRange = timeRange?.value || '24h';
            
            if (!selectedList) {
                showToast('Please select a list to analyze', 'error');
                return;
            }
            
            console.log('Starting analysis for list:', selectedList, 'time range:', selectedTimeRange);
            
            window.CreatorPal.Tracker.StateManager.setProcessingState(selectedList, true, 'Starting analysis...', 5);
            setAnalyzingState(true);
            
            fetch('/niche/analyze-creators', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    list_name: selectedList,
                    time_range: selectedTimeRange 
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Analysis response:', data);
                
                if (data.success) {
                    showToast('Analysis started! This will take a few minutes.', 'success');
                    startStatusPolling();
                } else {
                    console.log('Analysis failed to start:', data.error);
                    setAnalyzingState(false);
                    window.CreatorPal.Tracker.StateManager.clearProcessingState();
                    showToast(data.error || 'Error starting analysis', 'error');
                }
            })
            .catch(error => {
                console.error('Analysis start error:', error);
                setAnalyzingState(false);
                window.CreatorPal.Tracker.StateManager.clearProcessingState();
                showToast('Network error: ' + error.message, 'error');
            });
        }
        
        function startStatusPolling() {
            console.log('Starting status polling');
            
            if (window.TrackerState.statusCheckInterval) {
                clearInterval(window.TrackerState.statusCheckInterval);
            }
            
            let pollCount = 0;
            const maxPolls = 150;
            
            window.TrackerState.statusCheckInterval = setInterval(function() {
                pollCount++;
                
                fetch('/niche/get-status')
                .then(response => response.json())
                .then(data => {
                    console.log('Status poll:', data.status, 'running:', data.running);
                    
                    const currentState = window.CreatorPal.Tracker.StateManager.getProcessingState();
                    if (currentState && currentState.isProcessing) {
                        window.CreatorPal.Tracker.StateManager.setProcessingState(
                            currentState.listName, 
                            true, 
                            data.step || 'Processing...', 
                            data.progress || 10
                        );
                    }
                    
                    if (data.status === 'completed') {
                        console.log('Analysis completed!');
                        stopStatusPolling();
                        window.CreatorPal.Tracker.StateManager.clearProcessingState();
                        setAnalyzingState(false);
                        showToast('Analysis completed! Refreshing page...', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else if (data.status === 'error') {
                        console.log('Analysis error:', data.error);
                        stopStatusPolling();
                        window.CreatorPal.Tracker.StateManager.clearProcessingState();
                        setAnalyzingState(false);
                        showToast('Analysis failed: ' + (data.error || 'Unknown error'), 'error');
                    } else if (!data.running && data.status !== 'processing') {
                        console.log('Analysis stopped unexpectedly');
                        stopStatusPolling();
                        window.CreatorPal.Tracker.StateManager.clearProcessingState();
                        setAnalyzingState(false);
                        showToast('Analysis stopped. Please try again.', 'warning');
                    }
                    
                    if (pollCount >= maxPolls) {
                        console.log('Max polling duration reached');
                        stopStatusPolling();
                        window.CreatorPal.Tracker.StateManager.clearProcessingState();
                        setAnalyzingState(false);
                        showToast('Analysis taking longer than expected. Please check back later.', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    if (pollCount >= maxPolls) {
                        stopStatusPolling();
                        window.CreatorPal.Tracker.StateManager.clearProcessingState();
                        setAnalyzingState(false);
                        showToast('Connection lost. Please refresh the page.', 'error');
                    }
                });
            }, 2000);
        }
        
        function stopStatusPolling() {
            console.log('Stopping status polling');
            if (window.TrackerState.statusCheckInterval) {
                clearInterval(window.TrackerState.statusCheckInterval);
                window.TrackerState.statusCheckInterval = null;
            }
        }
        
        function setupViewToggle() {
            const analyticsBtn = document.getElementById('analytics-view-btn');
            const listsBtn = document.getElementById('lists-view-btn');
            
            if (analyticsBtn) {
                analyticsBtn.removeEventListener('click', analyticsClickHandler);
                analyticsBtn.addEventListener('click', analyticsClickHandler);
            }
            
            if (listsBtn) {
                listsBtn.removeEventListener('click', listsClickHandler);
                listsBtn.addEventListener('click', listsClickHandler);
            }
        }
        
        function analyticsClickHandler() {
            switchView('analytics');
        }
        
        function listsClickHandler() {
            switchView('lists');
        }
        
        function switchView(view) {
            const analyticsViewBtn = document.getElementById('analytics-view-btn');
            const listsViewBtn = document.getElementById('lists-view-btn');
            const analyticsPanel = document.getElementById('analytics-panel');
            const listsPanel = document.getElementById('lists-panel');
            
            if (view === 'analytics') {
                analyticsViewBtn?.classList.add('active');
                listsViewBtn?.classList.remove('active');
                analyticsPanel?.classList.remove('hidden');
                listsPanel?.classList.remove('active');
            } else {
                listsViewBtn?.classList.add('active');
                analyticsViewBtn?.classList.remove('active');
                analyticsPanel?.classList.add('hidden');
                listsPanel?.classList.add('active');
            }
        }
        
        function setupListTypeToggle() {
            const newListType = document.getElementById('new-list-type-select');
            const xListIdContainer = document.getElementById('x-list-id-container');
            const xListHelpContainer = document.getElementById('x-list-help-container');
            
            if (newListType && xListIdContainer && xListHelpContainer) {
                newListType.removeEventListener('change', listTypeChangeHandler);
                newListType.addEventListener('change', listTypeChangeHandler);
                listTypeChangeHandler.call(newListType);
            }
        }
        
        function listTypeChangeHandler() {
            const xListIdContainer = document.getElementById('x-list-id-container');
            const xListHelpContainer = document.getElementById('x-list-help-container');
            
            if (this.value === 'x_list') {
                if (xListIdContainer) xListIdContainer.classList.add('show');
                if (xListHelpContainer) xListHelpContainer.classList.add('show');
            } else {
                if (xListIdContainer) xListIdContainer.classList.remove('show');
                if (xListHelpContainer) xListHelpContainer.classList.remove('show');
            }
        }
        
        function setupCharts() {
            const chartDataElement = document.getElementById('chart-data');
            if (!chartDataElement) {
                console.log('No chart data found');
                return;
            }
            
            let chartData;
            try {
                chartData = JSON.parse(chartDataElement.textContent);
            } catch (error) {
                console.error('Error parsing chart data:', error);
                return;
            }
            
            console.log('Setting up charts with data:', chartData);
            
            // Destroy existing charts first
            Object.values(window.TrackerState.charts).forEach(chart => {
                if (chart && chart.destroy) {
                    chart.destroy();
                }
            });
            window.TrackerState.charts = {};
            
            const chartOptions = {
                chart: {
                    type: 'bar',
                    height: '100%',
                    toolbar: { show: false },
                    background: 'transparent',
                    fontFamily: 'Inter, sans-serif',
                    foreColor: '#a0aec0',
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 400
                    }
                },
                theme: { mode: 'dark' },
                grid: {
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    strokeDashArray: 3,
                    xaxis: { lines: { show: false } },
                    yaxis: { lines: { show: true } }
                },
                colors: ['#20D7D7'],
                plotOptions: {
                    bar: {
                        borderRadius: 8,
                        columnWidth: '60%',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                xaxis: {
                    labels: {
                        style: { 
                            colors: '#a0aec0', 
                            fontSize: '12px'
                        },
                        rotate: -45,
                        rotateAlways: true,
                        trim: true,
                        maxHeight: 100
                    },
                    axisBorder: { color: 'rgba(255, 255, 255, 0.1)' },
                    axisTicks: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                yaxis: {
                    labels: { 
                        style: { colors: '#a0aec0', fontSize: '12px' },
                        formatter: function(val) {
                            const rounded = Math.round(val);
                            if (rounded >= 1000000) {
                                return Math.round(rounded / 1000000) + 'M';
                            } else if (rounded >= 1000) {
                                return Math.round(rounded / 1000) + 'K';
                            }
                            return rounded.toString();
                        }
                    }
                },
                dataLabels: { enabled: false },
                tooltip: { 
                    theme: 'dark',
                    x: {
                        show: true
                    }
                }
            };
            
            // Initialize each chart with a slight delay to ensure proper rendering
            setTimeout(() => {
                initChart('tweets-chart', chartOptions, chartData.tweets_count, 'Tweets');
            }, 100);
            
            setTimeout(() => {
                initChart('likes-chart', chartOptions, chartData.likes_count, 'Likes');
            }, 200);
            
            setTimeout(() => {
                initChart('views-chart', chartOptions, chartData.views_count, 'Views');
            }, 300);
            
            setTimeout(() => {
                initEngagementChart(chartData.engagement_rate);
            }, 400);
        }
        
        function initChart(elementId, baseOptions, data, seriesName) {
            const element = document.getElementById(elementId);
            if (!element || !data) return;
            
            // Clear any existing content
            element.innerHTML = '';
            
            const config = {
                ...baseOptions,
                series: [{ 
                    name: seriesName, 
                    data: data.values.map(v => Math.round(v)) 
                }],
                xaxis: { 
                    ...baseOptions.xaxis, 
                    categories: data.creators,
                    labels: {
                        ...baseOptions.xaxis.labels,
                        formatter: function(value) {
                            // Ensure the value is treated as a string
                            return String(value);
                        }
                    }
                }
            };
            
            try {
                const chart = new ApexCharts(element, config);
                window.TrackerState.charts[elementId] = chart;
                chart.render();
            } catch (error) {
                console.error('Error creating chart:', elementId, error);
            }
        }
        
        function initEngagementChart(data) {
            const element = document.getElementById('engagement-chart');
            if (!element || !data) return;
            
            // Clear any existing content
            element.innerHTML = '';
            
            const config = {
                chart: {
                    type: 'bar',
                    height: '100%',
                    toolbar: { show: false },
                    background: 'transparent',
                    fontFamily: 'Inter, sans-serif',
                    foreColor: '#a0aec0',
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 400
                    }
                },
                theme: { mode: 'dark' },
                grid: {
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    strokeDashArray: 3,
                    xaxis: { lines: { show: false } },
                    yaxis: { lines: { show: true } }
                },
                colors: ['#20D7D7'],
                plotOptions: {
                    bar: { 
                        borderRadius: 8, 
                        columnWidth: '60%',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                xaxis: {
                    labels: {
                        style: { 
                            colors: '#a0aec0', 
                            fontSize: '12px'
                        },
                        rotate: -45,
                        rotateAlways: true,
                        trim: true,
                        maxHeight: 100,
                        formatter: function(value) {
                            // Ensure the value is treated as a string
                            return String(value);
                        }
                    },
                    categories: data.creators
                },
                yaxis: {
                    labels: {
                        style: { colors: '#a0aec0', fontSize: '12px' },
                        formatter: function(val) { return val.toFixed(1) + '%'; }
                    }
                },
                dataLabels: { enabled: false },
                tooltip: {
                    theme: 'dark',
                    x: {
                        show: true
                    },
                    y: { formatter: function(val) { return val.toFixed(1) + '%'; } }
                },
                series: [{ 
                    name: 'Engagement Rate (%)', 
                    data: data.values.map(v => parseFloat(v.toFixed(1))) 
                }]
            };
            
            try {
                const chart = new ApexCharts(element, config);
                window.TrackerState.charts['engagement-chart'] = chart;
                chart.render();
            } catch (error) {
                console.error('Error creating engagement chart:', error);
            }
        }
        
        // API Functions
        async function createList() {
            const listType = document.getElementById('new-list-type-select')?.value;
            const listName = document.getElementById('new-list-name-input')?.value?.trim();
            const xListId = document.getElementById('x-list-id-input')?.value?.trim();
            
            if (!listName) {
                showToast('Please enter a list name', 'error');
                return;
            }
            
            if (listType === 'x_list' && !xListId) {
                showToast('Please enter an X List ID', 'error');
                return;
            }
            
            const createBtn = document.getElementById('create-list-btn');
            setButtonLoading(createBtn, true);
            
            try {
                const data = { list_name: listName, list_type: listType };
                if (listType === 'x_list') {
                    data.x_list_id = xListId;
                }
                
                const response = await fetch('/niche/create-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('List created successfully!', 'success');
                    clearCreateForm();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast(result.message || 'Error creating list', 'error');
                }
            } catch (error) {
                showToast('Network error: ' + error.message, 'error');
            } finally {
                setButtonLoading(createBtn, false);
            }
        }
        
        async function setDefaultList(listName) {
            try {
                const response = await fetch('/niche/set-default-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ list_name: listName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Default list updated!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast(data.message || 'Error setting default list', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        }
        
        async function editList(listName) {
            window.TrackerState.currentEditingList = listName;
            
            try {
                const response = await fetch(`/niche/get-creators?list_name=${encodeURIComponent(listName)}`);
                const data = await response.json();
                
                if (data.success) {
                    displayCreatorsInModal(data.creators);
                    showModal('edit-list-modal');
                } else {
                    showToast('Error loading list creators', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        }
        
        async function addCreator() {
            const creatorHandle = document.getElementById('new-creator-handle-input')?.value?.trim();
            
            if (!creatorHandle) {
                showToast('Please enter a creator handle', 'error');
                return;
            }
            
            if (!window.TrackerState.currentEditingList) {
                showToast('No list selected', 'error');
                return;
            }
            
            const addBtn = document.getElementById('add-creator-btn');
            setButtonLoading(addBtn, true);
            
            try {
                const response = await fetch('/niche/add-creator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        list_name: window.TrackerState.currentEditingList,
                        creator_handle: creatorHandle
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Creator added successfully!', 'success');
                    document.getElementById('new-creator-handle-input').value = '';
                    displayCreatorsInModal(data.creators);
                } else {
                    showToast(data.message || 'Error adding creator', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            } finally {
                setButtonLoading(addBtn, false);
            }
        }
        
        async function removeCreator(creatorHandle) {
            if (!window.TrackerState.currentEditingList) return;
            
            try {
                const response = await fetch('/niche/remove-creator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        list_name: window.TrackerState.currentEditingList,
                        creator_handle: creatorHandle
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Creator removed successfully!', 'success');
                    displayCreatorsInModal(data.creators);
                } else {
                    showToast(data.error || 'Error removing creator', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            }
        }
        
        async function updateXList(listName) {
            const button = document.querySelector(`[data-list-name="${listName}"].update-x-list-btn`);
            if (button) setButtonLoading(button, true);
            
            try {
                const response = await fetch('/niche/update-x-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ list_name: listName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('X list updated successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast(data.message || 'Error updating X list', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            } finally {
                if (button) setButtonLoading(button, false);
            }
        }
        
        function confirmDeleteList(listName) {
            window.TrackerState.currentDeletingList = listName;
            document.getElementById('delete-list-name').textContent = `List: ${listName}`;
            showModal('delete-modal');
        }
        
        async function deleteList() {
            if (!window.TrackerState.currentDeletingList) return;
            
            const confirmBtn = document.getElementById('confirm-delete');
            setButtonLoading(confirmBtn, true);
            
            try {
                const response = await fetch('/niche/delete-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ list_name: window.TrackerState.currentDeletingList })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('List deleted successfully!', 'success');
                    hideModal('delete-modal');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast(data.error || 'Error deleting list', 'error');
                }
            } catch (error) {
                showToast('Network error', 'error');
            } finally {
                setButtonLoading(confirmBtn, false);
            }
        }
        
        // Helper Functions
        function displayCreatorsInModal(creators) {
            const creatorsList = document.getElementById('creators-list');
            if (!creatorsList) return;
            
            creatorsList.innerHTML = '';
            
            creators.forEach(creator => {
                const creatorCard = document.createElement('div');
                creatorCard.className = 'creator-card';
                creatorCard.innerHTML = `
                    <div class="creator-info">
                        <div class="creator-handle">@${creator}</div>
                    </div>
                    <button class="tracker-list-action-btn delete" onclick="removeCreator('${creator}')">
                        <i class="ph ph-trash"></i>
                    </button>
                `;
                creatorsList.appendChild(creatorCard);
            });
        }
        
        function clearCreateForm() {
            const inputs = ['new-list-name-input', 'x-list-id-input'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'flex';
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }
        
        function setButtonLoading(button, loading) {
            if (!button) return;
            
            if (loading) {
                button.setAttribute('data-original-content', button.innerHTML);
                button.innerHTML = '<div class="tracker-loading-spinner"></div> Loading...';
                button.disabled = true;
            } else {
                const originalContent = button.getAttribute('data-original-content');
                if (originalContent) {
                    button.innerHTML = originalContent;
                }
                button.disabled = false;
                button.removeAttribute('data-original-content');
            }
        }
        
        function showToast(message, type = 'info') {
            let toastContainer = document.getElementById('tracker-toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'tracker-toast-container';
                toastContainer.id = 'tracker-toast-container';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            let icon = 'info';
            
            if (type === 'success') icon = 'check-circle';
            else if (type === 'error') icon = 'warning-circle';
            else if (type === 'warning') icon = 'warning';
            
            toast.className = `tracker-toast ${type}`;
            toast.innerHTML = `
                <i class="ph ph-${icon}" style="font-size: 1.25rem;"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Expose removeCreator function globally for onclick handlers
        window.removeCreator = removeCreator;
        
        // Store cleanup function
        eventHandlers.cleanup = function() {
            console.log('Cleaning up tracker event listeners and state');
            
            // Stop polling
            stopStatusPolling();
            
            // Destroy charts
            if (window.TrackerState && window.TrackerState.charts) {
                Object.values(window.TrackerState.charts).forEach(chart => {
                    if (chart && chart.destroy) {
                        chart.destroy();
                    }
                });
                window.TrackerState.charts = {};
            }
            
            // Remove event listeners
            document.removeEventListener('click', eventHandlers.delegatedClick);
            document.removeEventListener('click', eventHandlers.modalClick);
            document.removeEventListener('keydown', eventHandlers.formKey);
        };
    }
    
    // Initialize on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('analytics-panel')) {
            initializeTracker();
        }
    });
    
    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('analytics-panel')) {
            console.log('DOM ready, initializing tracker');
            initializeTracker();
        }
    });
})();
</script>
{% endblock %}