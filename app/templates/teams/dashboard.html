{% extends "base.html" %}

{% block title %}Teams - Creator Tools{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/teams.css') }}">
{% endblock %}

{% block content %}
<div class="content-panel">
    <div class="teams-wrapper">
        <div class="teams-header">
            <h2 class="teams-title"><i class="ph ph-users-three"></i> Teams Management</h2>
            <div class="workspace-switcher">
                <label>Active Workspace:</label>
                <select id="workspaceSelector">
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>

        <div class="teams-container">
            <div id="alertContainer"></div>

            <!-- Pending Invitations Section -->
            <div id="pendingInvitationsSection" style="display: none;">
                <div class="alert alert-info">
                    <h3><i class="ph ph-envelope"></i> Pending Team Invitations</h3>
                    <div id="pendingInvitationsList"></div>
                </div>
            </div>

            <!-- Team Member View Message -->
            <div id="teamMemberMessage" style="display: none;">
                <div>
                    <i class="ph ph-users-three"></i>
                    <h2>Team Workspace</h2>
                    <p>
                        You're currently viewing a team workspace. You have access to the features granted by the workspace owner.
                        Switch back to your own workspace to manage your team.
                    </p>
                    <div id="permissionsList"></div>
                </div>
            </div>

            <div class="invite-section" id="inviteSection" style="display: none;">
        <h2>Invite Team Members</h2>
        <p>Add team members by email. They'll receive an invitation to join your workspace.</p>

        <div class="invite-form">
            <input type="email" id="inviteEmail" placeholder="Enter email address" />
            <button class="btn-invite" onclick="sendInvite()">
                <i class="ph ph-paper-plane-tilt"></i> Send Invite
            </button>
        </div>

        <div class="permissions-grid">
            <div class="permission-item">
                <input type="checkbox" id="perm_video_script" checked>
                <label for="perm_video_script">Video Script</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_video_title" checked>
                <label for="perm_video_title">Video Title</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_video_tags" checked>
                <label for="perm_video_tags">Video Tags</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_video_description" checked>
                <label for="perm_video_description">Video Description</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_thumbnail" checked>
                <label for="perm_thumbnail">Thumbnail</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_analytics" checked>
                <label for="perm_analytics">Analytics</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_competitors" checked>
                <label for="perm_competitors">Competitors</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_x_post_editor" checked>
                <label for="perm_x_post_editor">X Post Editor</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_reply_guy" checked>
                <label for="perm_reply_guy">Reply Guy</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_clip_spaces" checked>
                <label for="perm_clip_spaces">Clip Spaces</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_niche" checked>
                <label for="perm_niche">Niche</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_brain_dump" checked>
                <label for="perm_brain_dump">Brain Dump</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_mind_map" checked>
                <label for="perm_mind_map">Mind Map</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_content_wiki" checked>
                <label for="perm_content_wiki">Content Wiki</label>
            </div>
            <div class="permission-item">
                <input type="checkbox" id="perm_content_calendar" checked>
                <label for="perm_content_calendar">Content Calendar</label>
            </div>
            </div>
            </div>

            <div class="team-members-section" id="teamMembersSection" style="display: none;">
                <h2>Team Members</h2>
                <div class="team-members-list" id="teamMembersList">
                    <div class="empty-state">
                        <i class="ph ph-users"></i>
                        <p>No team members yet. Invite your first team member above.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Permissions Modal -->
<div id="editPermissionsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Permissions</h2>
            <button class="modal-close" onclick="closeModal('editPermissionsModal')">&times;</button>
        </div>
        <div id="editPermissionsContent">
            <!-- Permissions will be loaded here -->
        </div>
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn-edit-permissions" onclick="closeModal('editPermissionsModal')">Cancel</button>
            <button class="btn-invite" onclick="savePermissions()">Save Changes</button>
        </div>
    </div>
</div>

<script>
let currentMemberId = null;
let workspaces = [];

// Load workspaces on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadWorkspaces();

    // Only load team members if viewing own workspace
    const activeWorkspace = workspaces.find(w => w.is_active);
    if (activeWorkspace && activeWorkspace.is_owner) {
        loadTeamMembers();
    }

    loadPendingInvitations();
});

function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alertContainer.appendChild(alert);

    setTimeout(() => {
        alert.remove();
    }, 5000);
}

async function loadWorkspaces() {
    try {
        const response = await fetch('/teams/api/workspace');
        const data = await response.json();

        if (data.success) {
            workspaces = data.workspaces;
            const selector = document.getElementById('workspaceSelector');
            selector.innerHTML = '';

            workspaces.forEach(workspace => {
                const option = document.createElement('option');
                option.value = workspace.id;
                option.textContent = workspace.name + (workspace.is_owner ? ' (Owner)' : '');
                option.selected = workspace.is_active;
                selector.appendChild(option);
            });

            selector.addEventListener('change', switchWorkspace);

            // Show/hide sections based on current workspace
            updateUIForWorkspace();
        }
    } catch (error) {
        console.error('Error loading workspaces:', error);
    }
}

function updateUIForWorkspace() {
    // Find the currently active workspace
    const activeWorkspace = workspaces.find(w => w.is_active);

    if (activeWorkspace) {
        const inviteSection = document.getElementById('inviteSection');
        const teamMembersSection = document.getElementById('teamMembersSection');
        const teamMemberMessage = document.getElementById('teamMemberMessage');

        if (activeWorkspace.is_owner) {
            // Owner can see everything
            inviteSection.style.display = 'block';
            teamMembersSection.style.display = 'block';
            teamMemberMessage.style.display = 'none';
        } else {
            // Team member can't manage team - show message instead
            inviteSection.style.display = 'none';
            teamMembersSection.style.display = 'none';
            teamMemberMessage.style.display = 'block';

            // Show their permissions
            if (activeWorkspace.permissions) {
                const permsList = document.getElementById('permissionsList');
                const activePerms = Object.entries(activeWorkspace.permissions)
                    .filter(([_, allowed]) => allowed)
                    .map(([perm, _]) => {
                        const name = perm.replace(/_/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                        return `<span style="display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; background: var(--bg-primary); border: 1px solid var(--border-secondary); border-radius: 6px;">
                            âœ… ${name}
                        </span>`;
                    }).join('');

                if (activePerms) {
                    permsList.innerHTML = `
                        <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary);">Your Permissions:</h3>
                        <div>${activePerms}</div>
                    `;
                }
            }
        }
    }
}

async function switchWorkspace() {
    const workspaceId = document.getElementById('workspaceSelector').value;

    try {
        const response = await fetch('/teams/api/switch-workspace', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ workspace_id: workspaceId })
        });

        const data = await response.json();

        if (data.success) {
            // Reload the page to update navigation and all UI elements
            // This ensures base.html navigation reflects the new workspace context
            window.location.reload();
        } else {
            showAlert(data.error || 'Failed to switch workspace', 'error');
        }
    } catch (error) {
        showAlert('Error switching workspace', 'error');
    }
}

async function loadTeamMembers() {
    try {
        const response = await fetch('/teams/api/members');
        const data = await response.json();

        if (data.success) {
            const membersList = document.getElementById('teamMembersList');

            if (data.members.length === 0) {
                membersList.innerHTML = `
                    <div class="empty-state">
                        <i class="ph ph-users"></i>
                        <p>No team members yet. Invite your first team member above.</p>
                    </div>
                `;
            } else {
                // Check if current user is the owner
                const currentWorkspace = workspaces.find(w => w.is_active);
                const isOwner = currentWorkspace && currentWorkspace.is_owner;

                membersList.innerHTML = data.members.map(member => `
                    <div class="member-card">
                        <div class="member-info">
                            <div class="member-name">${member.name || member.email}</div>
                            <div class="member-email">${member.email}</div>
                            <span class="member-role">${member.role}</span>
                            <span class="status-badge status-${member.status}">${member.status}</span>
                        </div>
                        <div class="member-actions">
                            ${isOwner ? `
                                <button class="btn-edit-permissions" onclick="editPermissions('${member.id}', ${JSON.stringify(member.permissions).replace(/"/g, '&quot;')})">
                                    <i class="ph ph-gear"></i> Permissions
                                </button>
                                <button class="btn-remove" onclick="removeMember('${member.id}')">
                                    <i class="ph ph-trash"></i> Remove
                                </button>
                            ` : `
                                <div style="padding: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                                    Permissions: ${Object.entries(member.permissions)
                                        .filter(([_, allowed]) => allowed)
                                        .map(([perm, _]) => perm.replace('_', ' '))
                                        .join(', ') || 'None'}
                                </div>
                            `}
                        </div>
                    </div>
                `).join('');
            }
        }
    } catch (error) {
        console.error('Error loading team members:', error);
    }
}

async function sendInvite() {
    const email = document.getElementById('inviteEmail').value;

    if (!email) {
        showAlert('Please enter an email address', 'error');
        return;
    }

    // Gather permissions
    const permissions = {
        video_script: document.getElementById('perm_video_script').checked,
        video_title: document.getElementById('perm_video_title').checked,
        video_tags: document.getElementById('perm_video_tags').checked,
        video_description: document.getElementById('perm_video_description').checked,
        thumbnail: document.getElementById('perm_thumbnail').checked,
        analytics: document.getElementById('perm_analytics').checked,
        competitors: document.getElementById('perm_competitors').checked,
        x_post_editor: document.getElementById('perm_x_post_editor').checked,
        reply_guy: document.getElementById('perm_reply_guy').checked,
        clip_spaces: document.getElementById('perm_clip_spaces').checked,
        niche: document.getElementById('perm_niche').checked,
        brain_dump: document.getElementById('perm_brain_dump').checked,
        mind_map: document.getElementById('perm_mind_map').checked,
        content_wiki: document.getElementById('perm_content_wiki').checked,
        content_calendar: document.getElementById('perm_content_calendar').checked
    };

    try {
        const response = await fetch('/teams/api/invite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, permissions })
        });

        const data = await response.json();

        if (data.success) {
            showAlert(data.message);
            document.getElementById('inviteEmail').value = '';
            loadTeamMembers();
        } else {
            showAlert(data.error || 'Failed to send invitation', 'error');
        }
    } catch (error) {
        showAlert('Error sending invitation', 'error');
    }
}

function editPermissions(memberId, permissions) {
    currentMemberId = memberId;
    const modal = document.getElementById('editPermissionsModal');
    const content = document.getElementById('editPermissionsContent');

    const features = [
        { id: 'video_script', label: 'Video Script' },
        { id: 'video_title', label: 'Video Title' },
        { id: 'video_tags', label: 'Video Tags' },
        { id: 'video_description', label: 'Video Description' },
        { id: 'thumbnail', label: 'Thumbnail' },
        { id: 'analytics', label: 'Analytics' },
        { id: 'competitors', label: 'Competitors' },
        { id: 'x_post_editor', label: 'X Post Editor' },
        { id: 'reply_guy', label: 'Reply Guy' },
        { id: 'clip_spaces', label: 'Clip Spaces' },
        { id: 'niche', label: 'Niche' },
        { id: 'brain_dump', label: 'Brain Dump' },
        { id: 'mind_map', label: 'Mind Map' },
        { id: 'content_wiki', label: 'Content Wiki' },
        { id: 'content_calendar', label: 'Content Calendar' }
    ];

    content.innerHTML = `
        <div class="permissions-grid">
            ${features.map(feature => `
                <div class="permission-item">
                    <input type="checkbox" id="modal_perm_${feature.id}" ${permissions[feature.id] ? 'checked' : ''}>
                    <label for="modal_perm_${feature.id}">${feature.label}</label>
                </div>
            `).join('')}
        </div>
    `;

    modal.classList.add('active');
}

async function savePermissions() {
    if (!currentMemberId) return;

    const permissions = {
        video_script: document.getElementById('modal_perm_video_script').checked,
        video_title: document.getElementById('modal_perm_video_title').checked,
        video_tags: document.getElementById('modal_perm_video_tags').checked,
        video_description: document.getElementById('modal_perm_video_description').checked,
        thumbnail: document.getElementById('modal_perm_thumbnail').checked,
        analytics: document.getElementById('modal_perm_analytics').checked,
        competitors: document.getElementById('modal_perm_competitors').checked,
        x_post_editor: document.getElementById('modal_perm_x_post_editor').checked,
        reply_guy: document.getElementById('modal_perm_reply_guy').checked,
        clip_spaces: document.getElementById('modal_perm_clip_spaces').checked,
        niche: document.getElementById('modal_perm_niche').checked,
        brain_dump: document.getElementById('modal_perm_brain_dump').checked,
        mind_map: document.getElementById('modal_perm_mind_map').checked,
        content_wiki: document.getElementById('modal_perm_content_wiki').checked,
        content_calendar: document.getElementById('modal_perm_content_calendar').checked
    };

    try {
        const response = await fetch('/teams/api/update-permissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ member_id: currentMemberId, permissions })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Permissions updated successfully');
            closeModal('editPermissionsModal');
            loadTeamMembers();
        } else {
            showAlert(data.error || 'Failed to update permissions', 'error');
        }
    } catch (error) {
        showAlert('Error updating permissions', 'error');
    }
}

async function removeMember(memberId) {
    const permanent = confirm('Remove this team member?\n\nClick OK to remove (they can be re-invited later)\nClick Cancel to cancel');

    if (!permanent) return;

    try {
        const response = await fetch('/teams/api/remove-member', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                member_id: memberId,
                permanent: true  // Always permanently delete for cleaner list
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Member removed successfully');
            loadTeamMembers();
        } else {
            showAlert(data.error || 'Failed to remove member', 'error');
        }
    } catch (error) {
        showAlert('Error removing member', 'error');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

async function loadPendingInvitations() {
    try {
        const response = await fetch('/teams/api/pending-invitations');
        const data = await response.json();

        if (data.success && data.invitations && data.invitations.length > 0) {
            const section = document.getElementById('pendingInvitationsSection');
            const list = document.getElementById('pendingInvitationsList');

            section.style.display = 'block';

            list.innerHTML = data.invitations.map(invite => `
                <div style="padding: 1rem; background: var(--bg-primary); border-radius: 6px; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${invite.from_name}</strong> invited you to join their workspace
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Permissions: ${Object.entries(invite.permissions)
                                .filter(([_, allowed]) => allowed)
                                .map(([perm, _]) => perm.charAt(0).toUpperCase() + perm.slice(1).replace('_', ' '))
                                .join(', ') || 'None'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-invite" onclick="acceptInvitation('${invite.id}')" style="padding: 0.5rem 1rem;">
                            <i class="ph ph-check"></i> Accept
                        </button>
                        <button class="btn-remove" onclick="declineInvitation('${invite.id}')" style="padding: 0.5rem 1rem;">
                            <i class="ph ph-x"></i> Decline
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading pending invitations:', error);
    }
}

async function acceptInvitation(inviteId) {
    try {
        const response = await fetch('/teams/api/accept-invite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ invite_token: inviteId })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Invitation accepted successfully!');
            loadWorkspaces();
            loadPendingInvitations();
        } else {
            showAlert(data.error || 'Failed to accept invitation', 'error');
        }
    } catch (error) {
        showAlert('Error accepting invitation', 'error');
    }
}

async function declineInvitation(inviteId) {
    if (!confirm('Are you sure you want to decline this invitation?')) return;

    try {
        // Update invitation status to declined
        const response = await fetch('/teams/api/decline-invite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ invite_token: inviteId })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Invitation declined');
            loadPendingInvitations();
        } else {
            showAlert(data.error || 'Failed to decline invitation', 'error');
        }
    } catch (error) {
        showAlert('Error declining invitation', 'error');
    }
}
</script>
{% endblock %}